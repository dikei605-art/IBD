<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>AS Field Console - InBody</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
/* ===== AS FIELD APP - STYLES.CSS ===== */
/* InBody Brand Â· AS Field Console */

@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');

:root {
    --inbody-red: #9A2A2A;
    --inbody-red-dark: #7A1F1F;
    --inbody-red-light: #B23A3A;
    --inbody-red-pale: #F5E8E8;
    --inbody-accent: #C14545;

    --tech-color-1: #9A2A2A;
    --tech-color-2: #D97706;
    --tech-color-3: #059669;
    --tech-color-4: #2563EB;
    --tech-color-5: #7C3AED;

    --bg-primary: #FFFFFF;
    --bg-secondary: #F7F3EF;
    --bg-tertiary: #EADFDA;
    --border-light: #E0D5D0;
    --border-medium: #C8B8B0;

    --text-primary: #2D1B1B;
    --text-secondary: #5A4A4A;
    --text-tertiary: #8A7A7A;
    --text-inverse: #FFFFFF;

    --status-waiting: #F59E0B;
    --status-progress: #10B981;
    --status-complete: #6366F1;

    --shadow-sm: 0 1px 3px rgba(154,42,42,0.08);
    --shadow-md: 0 4px 12px rgba(154,42,42,0.12);
    --shadow-lg: 0 8px 24px rgba(154,42,42,0.16);
    --shadow-floating: 0 12px 32px rgba(154,42,42,0.2);
    --shadow-today: 0 0 0 3px rgba(154,42,42,0.3);

    --radius-sm: 8px;
    --radius-md: 14px;
    --radius-lg: 20px;
    --radius-xl: 28px;

    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --spacing-xl: 32px;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-secondary);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    width: 100%;
    max-width: 100vw;
}

.app-container {
    padding: 0;
    max-width: 100%;
    margin: 0 auto;
    min-height: 100vh;
    min-height: -webkit-fill-available;
    background: var(--bg-primary);
    box-shadow: var(--shadow-md);
    position: relative;
}

.app-header {
    background: linear-gradient(135deg, var(--inbody-red) 0%, var(--inbody-red-dark) 100%);
    padding: 12px 16px;
    color: white;
    position: -webkit-sticky;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header-compact { display: flex; gap: 12px; align-items: flex-start; }
.header-left { flex: 0 0 auto; }
.app-logo { margin-bottom: 6px; }
.logo-title { font-size: 22px; font-weight: 700; font-family: 'Outfit', sans-serif; line-height: 1; }
.logo-subtitle { font-size: 9px; letter-spacing: 0.5px; opacity: 0.7; text-transform: uppercase; }
.user-compact { display: flex; align-items: center; gap: 6px; font-size: 12px; flex-wrap: wrap; }
.user-name-compact { font-weight: 600; }
.user-divider { opacity: 0.5; }
.user-branch-compact { opacity: 0.8; }
.role-badge-compact { padding: 2px 8px; background: rgba(255,255,255,0.2); border-radius: 10px; font-size: 10px; font-weight: 600; }
.header-right { flex: 1; min-width: 0; }

.notice-compact { background: rgba(255,255,255,0.15); border-radius: 10px; padding: 8px 10px; border: 1px solid rgba(255,255,255,0.2); }
.notice-compact-header { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
.notice-icon-compact { font-size: 14px; }
.notice-title-compact { font-size: 12px; font-weight: 600; flex: 1; }
.notice-toggle-btn { background: rgba(255,255,255,0.2); border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; }
.notice-text-compact { font-size: 11px; line-height: 1.5; opacity: 0.95; margin-bottom: 4px; }
.notice-period-compact { font-size: 10px; opacity: 0.7; }

/* ===== FILTER CHIPS - REDESIGNED ===== */
.search-section { padding: var(--spacing-md); background: white; border-bottom: 1px solid var(--border-light); }

.search-box { position: relative; margin-bottom: var(--spacing-md); }
.search-input { width: 100%; padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 45px; border: 2px solid var(--border-light); border-radius: var(--radius-md); font-size: 14px; font-family: 'Noto Sans KR', sans-serif; transition: all 0.2s ease; }
.search-input:focus { outline: none; border-color: var(--inbody-red); }
.search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 18px; color: var(--text-tertiary); }

/* New Filter Design */
.filter-chips {
    display: flex;
    gap: 0;
    align-items: stretch;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    padding: 4px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.filter-chips::-webkit-scrollbar { display: none; }

/* "ì „ì²´" chip - Level 1 style */
.filter-chip-all {
    padding: 8px 18px;
    border-radius: var(--radius-sm);
    border: none;
    background: transparent;
    font-size: 13px;
    font-weight: 700;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-secondary);
    letter-spacing: 0.3px;
    flex-shrink: 0;
}
.filter-chip-all.active {
    background: var(--inbody-red);
    color: white;
    box-shadow: 0 2px 8px rgba(154,42,42,0.35);
}

/* Divider between ì „ì²´ and sub-filters */
.filter-divider {
    width: 1px;
    background: var(--border-medium);
    margin: 4px 4px;
    flex-shrink: 0;
}

/* Sub category chips - Level 2 */
.filter-chips-sub {
    display: flex;
    gap: 4px;
    align-items: center;
    flex-shrink: 0;
}

.filter-chip-sub {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1.5px solid var(--border-medium);
    background: white;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-secondary);
    flex-shrink: 0;
}
.filter-chip-sub.active {
    background: #2D1B1B;
    color: white;
    border-color: #2D1B1B;
}
.filter-chip-sub:active { transform: scale(0.95); }

/* Legacy support */
.filter-chip { padding: 8px 16px; border-radius: var(--radius-lg); border: 2px solid var(--border-medium); background: white; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all 0.2s ease; color: var(--text-secondary); }
.filter-chip.active { background: var(--inbody-red); color: white; border-color: var(--inbody-red); }
.filter-chip:active { transform: scale(0.95); }

/* ===== CALENDAR ===== */
.calendar-section { padding: var(--spacing-lg) var(--spacing-md); }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg); }
.month-selector { display: flex; align-items: center; gap: var(--spacing-md); }
.nav-button { width: 36px; height: 36px; border-radius: 50%; border: none; background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s ease; }
.nav-button:active { transform: scale(0.9); background: var(--inbody-red-pale); }
.current-month { font-size: 24px; font-weight: 700; font-family: 'Outfit', 'Noto Sans KR', sans-serif; color: var(--text-primary); cursor: pointer; padding: 8px 16px; border-radius: var(--radius-md); transition: all 0.2s ease; }
.today-button { padding: 8px 16px; border: 2px solid var(--inbody-red); background: transparent; color: var(--inbody-red); border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
.today-button:active { background: var(--inbody-red); color: white; }

.calendar-legend { display: flex; gap: var(--spacing-md); flex-wrap: wrap; margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-sm); }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; }

.calendar-grid { background: white; border-radius: var(--radius-lg); padding: var(--spacing-md); box-shadow: var(--shadow-sm); }
.weekdays { display: grid; grid-template-columns: repeat(7,1fr); gap: var(--spacing-xs); margin-bottom: var(--spacing-sm); }
.weekday { text-align: center; font-size: 12px; font-weight: 600; color: var(--text-tertiary); padding: var(--spacing-sm) 0; }
.weekday.sunday { color: #DC2626; }
.weekday.saturday { color: #2563EB; }
.days-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: var(--spacing-xs); }

.day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: var(--radius-sm); cursor: pointer; position: relative; transition: all 0.2s ease; background: #FFFFFF; border: 2px solid transparent; padding: 4px; }
.day-cell.other-month { opacity: 0.3; }
.day-cell.today { background: var(--inbody-red); color: white; font-weight: 700; }
.day-cell.today.selected { box-shadow: var(--shadow-today); }
.day-cell.has-schedule { border-color: var(--inbody-red-light); background: #FFEAEA; }
.day-cell.selected:not(.today) { border-color: var(--inbody-red); background: var(--inbody-red-pale); }
.day-cell:active { transform: scale(0.95); }
.day-number { font-size: 14px; font-weight: 600; line-height: 1; margin-bottom: 2px; color: #1A1A1A; }
.day-schedules { font-size: 9px; line-height: 1.2; text-align: center; width: 100%; }
.day-schedule-item { display: flex; align-items: center; justify-content: center; gap: 2px; margin: 1px 0; }
.day-schedule-dot { width: 4px; height: 4px; border-radius: 50%; flex-shrink: 0; }
.day-schedule-name { font-weight: 700; flex-shrink: 0; color: #2D1B1B; }
.day-schedule-count { font-weight: 600; color: #2D1B1B; }

.day-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-8px); background: rgba(45,27,27,0.95); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); color: white; padding: 8px 12px; border-radius: var(--radius-sm); font-size: 11px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.2s ease; z-index: 10; box-shadow: var(--shadow-lg); }
.day-cell:hover .day-tooltip { opacity: 1; }
.tooltip-item { display: flex; align-items: center; gap: 6px; margin: 2px 0; }
.tooltip-dot { width: 6px; height: 6px; border-radius: 50%; }

/* ===== SCHEDULE LIST ===== */
.schedule-section { padding: 0 var(--spacing-md); padding-bottom: calc(90px + env(safe-area-inset-bottom, 20px)); }
.section-title { font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm); }
.section-date { color: var(--inbody-red); }
.time-section { margin-bottom: var(--spacing-lg); }
.time-header { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm); }
.time-icon { width: 20px; height: 20px; border-radius: 50%; background: var(--inbody-red-pale); display: flex; align-items: center; justify-content: center; font-size: 12px; }

.schedule-card { background: white; border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md); box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.3s ease; border-left: 4px solid transparent; position: relative; }
.schedule-card:active { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

/* Route button in schedule card header area */
.card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-sm); }
.card-time { background: var(--inbody-red); color: white; padding: 4px 10px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; font-family: 'Outfit', sans-serif; }
.card-header-right { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
.status-badge { padding: 4px 10px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600; }
.status-waiting { background: #FEF3C7; color: var(--status-waiting); }
.status-progress { background: #D1FAE5; color: var(--status-progress); }
.status-complete { background: #E0E7FF; color: var(--status-complete); }
.card-company { font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-xs); }
.card-info { display: flex; flex-direction: column; gap: 4px; }
.info-row { display: flex; align-items: center; gap: var(--spacing-sm); font-size: 13px; color: var(--text-secondary); }
.info-label { color: var(--text-tertiary); min-width: 60px; }
.info-value { color: var(--text-primary); font-weight: 500; }

/* ===== SCHEDULE FILTERS ===== */
.schedule-filters-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.schedule-filters { display: flex; gap: 8px; flex-wrap: wrap; flex: 1; }
.schedule-filter-btn { padding: 8px 16px; border-radius: 8px; border: 2px solid var(--inbody-red); background: white; color: var(--inbody-red); font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 13px; font-family: 'Noto Sans KR', sans-serif; }
.schedule-filter-btn.active { background: var(--inbody-red); color: white; }
.schedule-filter-btn:active { transform: scale(0.95); }

/* Route Button */
.route-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: 2px solid #059669;
    background: white;
    color: #059669;
    font-weight: 700;
    cursor: pointer;
    font-size: 13px;
    font-family: 'Noto Sans KR', sans-serif;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}
.route-btn:active { background: #059669; color: white; transform: scale(0.97); }

/* ===== MODAL ===== */
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); z-index: 1000; display: none; opacity: 0; transition: opacity 0.3s ease; }
.modal-overlay.active { display: flex; opacity: 1; align-items: flex-end; justify-content: center; }
.modal-content { background: white; width: 100%; max-width: 100%; max-height: 90vh; border-radius: var(--radius-xl) var(--radius-xl) 0 0; overflow-y: auto; -webkit-overflow-scrolling: touch; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4,0,0.2,1); }
.modal-overlay.active .modal-content { transform: translateY(0); }

.modal-header { position: -webkit-sticky; position: sticky; top: 0; background: white; padding: var(--spacing-lg) var(--spacing-md) var(--spacing-md); border-bottom: 1px solid var(--border-light); z-index: 10; }
.modal-handle { width: 40px; height: 4px; background: var(--border-medium); border-radius: 2px; margin: 0 auto var(--spacing-md); }

/* Modal title row - back button left, title center, close button right */
.modal-title-row { display: flex; justify-content: space-between; align-items: center; position: relative; }
.modal-title { font-size: 20px; font-weight: 700; color: var(--text-primary); position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; }
.modal-title-spacer { width: 32px; flex-shrink: 0; }

.back-button {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
    flex-shrink: 0;
    z-index: 1;
}
.back-button:active { background: var(--border-light); transform: scale(0.9); }

.close-button { width: 32px; height: 32px; border-radius: 50%; border: none; background: var(--bg-tertiary); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.2s ease; flex-shrink: 0; z-index: 1; }
.close-button:active { background: var(--border-light); transform: scale(0.9); }

.modal-body { padding: var(--spacing-lg) var(--spacing-md) var(--spacing-xl); }

/* ===== DETAIL SECTIONS ===== */
.detail-section { margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md); }
.detail-section-title { font-size: 12px; font-weight: 700; color: var(--inbody-red); text-transform: uppercase; letter-spacing: 1px; margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm); }
.section-icon { font-size: 16px; }
.detail-row { display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--border-light); align-items: center; }
.detail-row:last-child { border-bottom: none; }
.detail-label { font-size: 14px; color: var(--text-tertiary); font-weight: 500; }
.detail-value { font-size: 14px; color: var(--text-primary); font-weight: 600; text-align: right; }
.warranty-badge { padding: 4px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 700; }
.warranty-free { background: #D1FAE5; color: #059669; }
.warranty-paid { background: #FEE2E2; color: #DC2626; }
.detail-full { padding: var(--spacing-md); background: white; border-radius: var(--radius-sm); margin-top: var(--spacing-sm); }
.detail-full-label { font-size: 12px; color: var(--text-tertiary); font-weight: 600; margin-bottom: var(--spacing-sm); }
.detail-full-value { font-size: 14px; color: var(--text-primary); line-height: 1.6; }

/* ===== ACTION BUTTONS ===== */
.action-buttons { display: grid; grid-template-columns: repeat(3,1fr); gap: var(--spacing-md); margin-top: var(--spacing-lg); }
.action-button { padding: var(--spacing-md); border-radius: var(--radius-md); border: 2px solid var(--border-medium); background: white; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: var(--spacing-sm); font-size: 13px; font-weight: 600; color: var(--text-primary); }
.action-button:active { transform: scale(0.95); border-color: var(--inbody-red); }
.action-icon { font-size: 24px; }

/* ===== FORM ELEMENTS ===== */
.form-group { margin-bottom: var(--spacing-lg); }
.form-label { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-sm); display: block; }
.form-label-required::after { content: ' *'; color: #DC2626; }
.form-select { width: 100%; padding: var(--spacing-md); border: 2px solid var(--border-light); border-radius: var(--radius-sm); font-size: 14px; font-family: 'Noto Sans KR', sans-serif; background: white; transition: all 0.2s ease; }
.form-select:focus { outline: none; border-color: var(--inbody-red); }
.form-input { width: 100%; padding: var(--spacing-md); border: 2px solid var(--border-light); border-radius: var(--radius-sm); font-size: 14px; font-family: 'Noto Sans KR', sans-serif; transition: all 0.2s ease; }
.form-input:focus { outline: none; border-color: var(--inbody-red); }
.form-input-with-icon { position: relative; }
.form-input-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 20px; color: var(--inbody-red); cursor: pointer; transition: all 0.2s ease; }
.form-input-icon:active { transform: translateY(-50%) scale(0.9); }
.form-textarea { width: 100%; min-height: 120px; padding: var(--spacing-md); border: 2px solid var(--border-light); border-radius: var(--radius-sm); font-size: 14px; font-family: 'Noto Sans KR', sans-serif; resize: vertical; transition: all 0.2s ease; }
.form-textarea:focus { outline: none; border-color: var(--inbody-red); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); }
.form-row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: var(--spacing-md); }

/* Camera button inline */
.section-title-with-camera {
    display: flex;
    align-items: center;
    gap: 8px;
}
.camera-btn-inline {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: none;
    background: var(--inbody-red-pale);
    color: var(--inbody-red);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}
.camera-btn-inline:active { background: var(--inbody-red); color: white; transform: scale(0.9); }

/* Version camera */
.version-input-row { display: flex; gap: 8px; align-items: center; }
.version-input-row .form-input { flex: 1; }
.qr-scan-btn { padding: 0 14px; height: 48px; border-radius: var(--radius-sm); border: 2px solid var(--inbody-red); background: var(--inbody-red-pale); color: var(--inbody-red); cursor: pointer; font-size: 18px; flex-shrink: 0; display: flex; align-items: center; transition: all 0.2s ease; }
.qr-scan-btn:active { background: var(--inbody-red); color: white; }

/* ===== MATERIAL ITEMS ===== */
.material-item { background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md); }
.material-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm); }
.material-remove { color: #DC2626; cursor: pointer; font-size: 20px; }
.add-material-btn { width: 100%; padding: var(--spacing-md); border: 2px dashed var(--border-medium); background: white; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; color: var(--inbody-red); cursor: pointer; transition: all 0.2s ease; font-family: 'Noto Sans KR', sans-serif; }
.add-material-btn:active { transform: scale(0.98); background: var(--inbody-red-pale); }

/* ===== BUTTON GROUPS ===== */
.button-group { display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg); }
.btn-secondary { flex: 1; padding: var(--spacing-md); background: white; color: var(--text-primary); border: 2px solid var(--border-medium); border-radius: var(--radius-md); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-family: 'Noto Sans KR', sans-serif; }
.btn-secondary:active { transform: scale(0.98); background: var(--bg-tertiary); }
.btn-primary { flex: 1; padding: var(--spacing-md); background: var(--inbody-red); color: white; border: none; border-radius: var(--radius-md); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-family: 'Noto Sans KR', sans-serif; }
.btn-primary:active { transform: scale(0.98); background: var(--inbody-red-dark); }

/* ===== INQUIRY ===== */
.inquiry-list { margin-top: var(--spacing-lg); }
.inquiry-list-title { font-size: 14px; font-weight: 700; color: var(--text-secondary); margin-bottom: var(--spacing-md); }
.inquiry-card { background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-sm); cursor: pointer; border-left: 3px solid var(--inbody-red); transition: all 0.2s ease; }
.inquiry-card:active { transform: translateX(4px); }
.inquiry-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-sm); }
.inquiry-title { font-size: 15px; font-weight: 700; color: var(--text-primary); }
.inquiry-date { font-size: 11px; color: var(--text-tertiary); }
.inquiry-meta { font-size: 12px; color: var(--text-secondary); line-height: 1.4; }
.priority-badge { display: inline-block; padding: 2px 8px; border-radius: var(--radius-sm); font-size: 10px; font-weight: 700; margin-left: var(--spacing-sm); }
.priority-high { background: #FEE2E2; color: #DC2626; }
.priority-medium { background: #FEF3C7; color: #F59E0B; }
.priority-low { background: #DBEAFE; color: #2563EB; }

/* ===== PHOTO UPLOAD ===== */
.photo-upload-area { border: 2px dashed var(--border-medium); border-radius: var(--radius-md); padding: var(--spacing-lg); text-align: center; cursor: pointer; transition: all 0.2s ease; background: var(--bg-secondary); }
.photo-upload-area:active { background: var(--inbody-red-pale); border-color: var(--inbody-red); }
.photo-icon { font-size: 48px; margin-bottom: var(--spacing-sm); color: var(--text-tertiary); }
.photo-text { font-size: 14px; color: var(--text-secondary); }
.photo-preview { display: grid; grid-template-columns: repeat(3,1fr); gap: var(--spacing-sm); margin-top: var(--spacing-md); }
.photo-item { position: relative; aspect-ratio: 1; border-radius: var(--radius-sm); overflow: hidden; }
.photo-item img { width: 100%; height: 100%; object-fit: cover; }
.photo-remove { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; }

/* ===== QUICK ACTIONS ===== */
.quick-actions-fixed { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: var(--spacing-md); padding-bottom: calc(var(--spacing-md) + env(safe-area-inset-bottom, 0px)); box-shadow: 0 -4px 12px rgba(0,0,0,0.1); z-index: 90; max-width: 100%; margin: 0 auto; }
.quick-action-btn { padding: var(--spacing-md); border-radius: var(--radius-md); border: 2px solid var(--inbody-red); background: white; color: var(--inbody-red); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); font-family: 'Noto Sans KR', sans-serif; }
.quick-action-btn:active { transform: scale(0.97); background: var(--inbody-red); color: white; }
.action-btn-icon { font-size: 18px; }

/* ===== PICKER MODAL ===== */
.picker-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); z-index: 1100; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
.picker-modal.active { display: flex; opacity: 1; }
.picker-content { background: white; width: 90%; max-width: 400px; border-radius: var(--radius-lg); padding: var(--spacing-lg); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); }
.picker-modal.active .picker-content { transform: scale(1); }
.picker-title { font-size: 18px; font-weight: 700; text-align: center; margin-bottom: var(--spacing-lg); color: var(--text-primary); }
.picker-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: var(--spacing-md); }
.picker-item { padding: var(--spacing-md); border-radius: var(--radius-sm); border: 2px solid var(--border-light); background: white; cursor: pointer; text-align: center; font-size: 16px; font-weight: 600; transition: all 0.2s ease; font-family: 'Noto Sans KR', sans-serif; }
.picker-item:active { transform: scale(0.95); }
.picker-item.selected { background: var(--inbody-red); color: white; border-color: var(--inbody-red); }

/* ===== EMPTY STATE ===== */
.empty-state { text-align: center; padding: var(--spacing-xl); color: var(--text-tertiary); }
.empty-icon { font-size: 64px; margin-bottom: var(--spacing-md); opacity: 0.3; }
.empty-text { font-size: 16px; font-weight: 500; }

/* ===== ROUTE MODAL ===== */
.route-modal-content {
    background: white;
    width: 100%;
    max-height: 90vh;
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}
.route-map-placeholder {
    background: #E8F5E9;
    border-radius: var(--radius-md);
    padding: 24px;
    text-align: center;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    border: 2px dashed #A5D6A7;
    margin-bottom: 16px;
}
.route-stop-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
    border-left: 3px solid var(--inbody-red);
}
.route-stop-num {
    width: 24px; height: 24px;
    border-radius: 50%;
    background: var(--inbody-red);
    color: white;
    font-size: 12px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.route-stop-info { flex: 1; }
.route-stop-company { font-size: 14px; font-weight: 700; }
.route-stop-address { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.origin-input-section { background: var(--bg-secondary); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px; }
.saved-origins { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
.origin-tag { padding: 6px 12px; border-radius: 20px; border: 1.5px solid var(--border-medium); background: white; font-size: 12px; cursor: pointer; transition: all 0.2s; font-family: 'Noto Sans KR', sans-serif; }
.origin-tag.active { background: var(--inbody-red); color: white; border-color: var(--inbody-red); }

/* ===== ìœ ìƒë¬´ìƒ ë³´ê³ ìš© POPUP ===== */
.warranty-report-popup {
    background: white;
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    max-height: 90vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
}
.report-header-bar {
    background: linear-gradient(135deg, var(--inbody-red), var(--inbody-red-dark));
    color: white;
    padding: 16px 20px;
    text-align: center;
}
.report-header-bar h3 { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
.report-header-bar p { font-size: 11px; opacity: 0.8; }
.report-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
}
.report-cell {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-light);
    border-right: 1px solid var(--border-light);
}
.report-cell:nth-child(even) { border-right: none; }
.report-cell-label { font-size: 10px; color: var(--text-tertiary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.report-cell-value { font-size: 13px; color: var(--text-primary); font-weight: 600; margin-top: 2px; }
.report-cell-full {
    grid-column: 1 / -1;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-light);
}

/* ===== ì²˜ë¦¬ë°©ë²• ê°€ì´ë“œ ===== */
.guide-section {
    background: linear-gradient(135deg, #FFF8E1, #FFF3E0);
    border: 2px solid #FFB300;
    border-radius: var(--radius-md);
    padding: 0;
    margin-bottom: var(--spacing-md);
    overflow: hidden;
}
.guide-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: #FFB300;
    cursor: pointer;
    transition: all 0.2s;
}
.guide-section-header:active { background: #F9A800; }
.guide-title-badge { display: flex; align-items: center; gap: 8px; }
.guide-badge { background: white; color: #E65100; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; }
.guide-title-text { font-size: 14px; font-weight: 700; color: white; }
.guide-toggle-icon { font-size: 16px; color: white; transition: transform 0.2s; }
.guide-toggle-icon.open { transform: rotate(180deg); }
.guide-body { padding: 16px; display: none; }
.guide-body.open { display: block; }

.guide-item {
    background: white;
    border-radius: var(--radius-sm);
    margin-bottom: 12px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.guide-item-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: #FFF8E1;
    border-bottom: 1px solid #FFE082;
}
.guide-item-num {
    width: 22px; height: 22px;
    border-radius: 50%;
    background: #FF8F00;
    color: white;
    font-size: 11px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.guide-item-title { font-size: 13px; font-weight: 700; color: #4E342E; }
.guide-item-content { padding: 10px 12px; font-size: 13px; color: var(--text-secondary); line-height: 1.6; }
.guide-media-placeholder { background: var(--bg-secondary); border-radius: 6px; padding: 12px; text-align: center; color: var(--text-tertiary); font-size: 12px; margin-top: 8px; border: 1px dashed var(--border-medium); cursor: pointer; }
.guide-tag-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.guide-tag { padding: 3px 10px; background: #FFF3E0; border-radius: 12px; font-size: 11px; color: #E65100; font-weight: 600; }

/* ===== AI ASSISTANT ===== */
.ai-section {
    background: linear-gradient(135deg, #E8EAF6, #EDE7F6);
    border: 2px solid #7986CB;
    border-radius: var(--radius-md);
    padding: 0;
    margin-bottom: var(--spacing-md);
    overflow: hidden;
}
.ai-section-header {
    background: linear-gradient(135deg, #3F51B5, #5C35B5);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.ai-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; color: white; letter-spacing: 0.5px; }
.ai-section-title { font-size: 14px; font-weight: 700; color: white; }
.ai-body { padding: 14px; }
.ai-input-row { display: flex; gap: 8px; }
.ai-input { flex: 1; padding: 10px 14px; border: 2px solid #C5CAE9; border-radius: 22px; font-size: 14px; font-family: 'Noto Sans KR', sans-serif; background: white; transition: all 0.2s; }
.ai-input:focus { outline: none; border-color: #3F51B5; }
.ai-send-btn { padding: 0 16px; border-radius: 22px; border: none; background: #3F51B5; color: white; font-size: 16px; cursor: pointer; transition: all 0.2s; }
.ai-send-btn:active { background: #303F9F; }
.ai-response-area { margin-top: 12px; min-height: 60px; background: white; border-radius: var(--radius-sm); padding: 12px; font-size: 13px; color: var(--text-primary); line-height: 1.7; border: 1px solid #C5CAE9; display: none; }
.ai-response-area.visible { display: block; }
.ai-thinking { color: var(--text-tertiary); font-style: italic; font-size: 12px; display: flex; align-items: center; gap: 6px; }
.ai-dot-anim { display: inline-flex; gap: 3px; }
.ai-dot-anim span { width: 5px; height: 5px; border-radius: 50%; background: #7986CB; animation: aiDot 1.2s infinite; }
.ai-dot-anim span:nth-child(2) { animation-delay: 0.2s; }
.ai-dot-anim span:nth-child(3) { animation-delay: 0.4s; }
@keyframes aiDot { 0%,60%,100%{opacity:0.2;transform:scale(0.8)} 30%{opacity:1;transform:scale(1)} }

/* ===== CHECKLIST ===== */
.checklist-section {
    background: #F1F8E9;
    border: 2px solid #8BC34A;
    border-radius: var(--radius-md);
    overflow: hidden;
    margin-bottom: var(--spacing-md);
}
.checklist-header {
    background: #558B2F;
    padding: 10px 14px;
    display: flex; align-items: center; gap: 8px;
}
.checklist-title { font-size: 14px; font-weight: 700; color: white; }
.checklist-body { padding: 12px; }
.checklist-empty { text-align: center; color: var(--text-tertiary); font-size: 13px; padding: 8px 0; font-style: italic; }
.check-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 10px;
    background: white;
    border-radius: 8px;
    margin-bottom: 6px;
    border: 1px solid #C5E1A5;
    cursor: pointer;
    transition: all 0.2s;
}
.check-item.checked { background: #E8F5E9; border-color: #66BB6A; }
.check-item-box {
    width: 20px; height: 20px;
    border-radius: 5px;
    border: 2px solid #8BC34A;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    margin-top: 1px;
    transition: all 0.2s;
}
.check-item.checked .check-item-box { background: #4CAF50; border-color: #4CAF50; color: white; }
.check-item-label { font-size: 13px; color: var(--text-primary); flex: 1; line-height: 1.4; }
.check-item.checked .check-item-label { color: var(--text-secondary); text-decoration: line-through; }
.checklist-hint { font-size: 11px; color: #558B2F; margin-top: 8px; text-align: center; font-style: italic; }

/* ===== HIDDEN ===== */
.hidden-file-input { display: none; }

/* ===== COPY / CAPTURE BUTTONS ===== */
.btn-copy {
    flex: 1;
    padding: var(--spacing-md);
    background: #059669;
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Noto Sans KR', sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
.btn-copy:active { transform: scale(0.97); background: #047857; }

.btn-capture {
    flex: 1;
    padding: var(--spacing-md);
    background: #2563EB;
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Noto Sans KR', sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
.btn-capture:active { transform: scale(0.97); background: #1d4ed8; }

/* ===== METHOD CHIP GROUP (ì‹ ê·œì ‘ìˆ˜) ===== */
.method-chip-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.method-chip {
    flex: 1;
    min-width: 52px;
    padding: 9px 4px;
    border: 2px solid var(--border-light);
    border-radius: 20px;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    cursor: pointer;
    transition: all 0.18s ease;
    text-align: center;
    -webkit-tap-highlight-color: transparent;
}
.method-chip:active { transform: scale(0.95); }
.method-chip-active {
    background: var(--inbody-red);
    border-color: var(--inbody-red);
    color: #fff;
    box-shadow: 0 2px 8px rgba(154,42,42,0.28);
}
/* ===== iOS COMPATIBILITY ===== */
html { -webkit-text-size-adjust: 100%; height: -webkit-fill-available; }
body { min-height: 100vh; min-height: -webkit-fill-available; }
.app-header {
    padding-top: max(12px, env(safe-area-inset-top));
}
.form-input, .form-select, .form-textarea, .ai-input, .search-input {
    font-size: 16px !important;
    -webkit-appearance: none;
    appearance: none;
}
.form-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235A4A4A' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-color: white;
    padding-right: 36px;
}
.quick-actions-fixed {
    padding-bottom: max(16px, env(safe-area-inset-bottom));
}
.modal-content {
    padding-bottom: env(safe-area-inset-bottom, 0px);
}
button, .filter-chip-all, .filter-chip-sub, .filter-chip,
.schedule-filter-btn, .method-chip, .quick-action-btn,
.nav-button, .today-button, .back-button, .close-button,
.notice-toggle-btn, .action-button, .picker-item,
.schedule-card, .day-cell, .check-item, .origin-tag,
.add-material-btn, .btn-primary, .btn-secondary, .btn-copy, .btn-capture {
    touch-action: manipulation;
    -webkit-tap-highlight-color: rgba(154,42,42,0.08);
    cursor: pointer;
}
/* iOS Safari: transitionì´ ìˆìœ¼ë©´ ì²« íƒ­ì´ hoverë¡œ ì²˜ë¦¬ë˜ì–´ ë‘ ë²ˆ ëˆŒëŸ¬ì•¼ í•  ìˆ˜ ìˆìŒ - ë°©ì§€ */
.schedule-card, .day-cell, .inquiry-card {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
}
.filter-chip-all, .filter-chip-sub, .method-chip, .quick-action-btn {
    -webkit-user-select: none;
    user-select: none;
}

/* ===== iOS-SAFE CALENDAR GRID (replace grid with flex) ===== */
.weekdays {
    display: -webkit-flex !important;
    display: flex !important;
    width: 100%;
}
.weekday {
    -webkit-flex: 1;
    flex: 1;
    min-width: 0;
}
.days-grid {
    display: -webkit-flex !important;
    display: flex !important;
    -webkit-flex-wrap: wrap !important;
    flex-wrap: wrap !important;
    width: 100%;
}
.day-cell {
    -webkit-flex: 0 0 calc(100% / 7) !important;
    flex: 0 0 calc(100% / 7) !important;
    width: calc(100% / 7) !important;
    aspect-ratio: unset !important;
    min-height: 52px;
    height: 52px;
    display: -webkit-flex !important;
    display: flex !important;
    -webkit-flex-direction: column;
    flex-direction: column;
    -webkit-align-items: center;
    align-items: center;
    -webkit-justify-content: center;
    justify-content: center;
    box-sizing: border-box !important;
    overflow: hidden;
}

/* ===== DEVICE TYPE BADGES ===== */
.device-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 3px 8px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    flex-shrink: 0;
    line-height: 1.2;
}
.db-inbody { background: #FEE2E2; color: #9A2A2A; border: 1px solid #FECACA; }
.db-height  { background: #DBEAFE; color: #1D4ED8; border: 1px solid #BFDBFE; }
.db-bp      { background: #D1FAE5; color: #065F46; border: 1px solid #A7F3D0; }
.db-other   { background: #F3F4F6; color: #374151; border: 1px solid #D1D5DB; }

/* ===== DEVICE SUMMARY BAR ===== */
.device-summary-bar {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin: 6px 0 12px;
    padding: 10px 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
}
.device-summary-label {
    font-size: 10px;
    color: var(--text-tertiary);
    font-weight: 700;
    width: 100%;
    margin-bottom: 2px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.device-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 11px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    border: 1.5px solid transparent;
}
.dc-inbody { background: #FEE2E2; color: #9A2A2A; border-color: #FECACA; }
.dc-height  { background: #DBEAFE; color: #1D4ED8; border-color: #BFDBFE; }
.dc-bp      { background: #D1FAE5; color: #065F46; border-color: #A7F3D0; }
.dc-other   { background: #F3F4F6; color: #374151; border-color: #D1D5DB; }
.dc-num     { font-size: 13px; font-weight: 800; }

/* ===== DEVICE TYPE CHIP GROUP (ì‹ ê·œì ‘ìˆ˜) ===== */
.device-chip-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.device-type-chip {
    flex: 1;
    min-width: 60px;
    padding: 10px 4px;
    border: 2px solid var(--border-light);
    border-radius: 20px;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-size: 12px;
    font-weight: 600;
    font-family: 'Noto Sans KR', sans-serif;
    cursor: pointer;
    text-align: center;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
}
.device-type-chip.active {
    background: var(--inbody-red);
    border-color: var(--inbody-red);
    color: white;
}


/* ===== UI17 TAB BAR (ìŠ¤ì¼€ì¥´ / ì‹ ê·œì ‘ìˆ˜ / CSë¬¸ì˜) ===== */
.ui17-tabbar{
    position: fixed;
    left: 0; right: 0; bottom: 0;
    background: #fff;
    border-top: 1px solid var(--border-light);
    box-shadow: 0 -6px 18px rgba(0,0,0,0.08);
    display: flex;
    z-index: 95;
    padding-bottom: max(10px, env(safe-area-inset-bottom, 0px));
}
.ui17-tab{
    flex: 1;
    border: none;
    background: transparent;
    padding: 10px 6px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    font-family: 'Noto Sans KR', sans-serif;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
}
.ui17-tab-top{
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    letter-spacing: 0.8px;
    font-weight: 700;
    color: var(--text-tertiary);
}
.ui17-tab-sub{
    font-size: 11px;
    font-weight: 700;
    color: var(--text-secondary);
}
.ui17-tab.active .ui17-tab-top,
.ui17-tab.active .ui17-tab-sub{
    color: var(--inbody-red);
}

/* ===== Schedule Filters UI ê°œì„  (ì „ì²´ë³´ê¸° 1ì¤„ + ê¸°ì‚¬ëª©ë¡ ì•„ë˜ì¤„) ===== */
.schedule-filters-stack{ display:flex; flex-direction:column; gap:8px; flex:1; min-width:0; }
.schedule-filters-all{ display:flex; }
.schedule-filters-techs{ display:flex; gap:8px; flex-wrap:wrap; }


/* ===== UI19 small fixes ===== */
.action-button { justify-content: center; }
.action-button > div:last-child{
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  line-height:1.2;
  min-height:28px;
  width:100%;
}
.daypopup-toggle{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:6px 8px;
  margin-bottom:6px;
  border:1px solid rgba(0,0,0,0.06);
  border-radius:12px;
  background:rgba(255,255,255,0.8);
}
.daypopup-label{ font-size:12px; font-weight:700; color:rgba(0,0,0,0.65); }
/* switch */
.switch{ position:relative; display:inline-block; width:44px; height:26px; }
.switch input{ opacity:0; width:0; height:0; }
.slider{
  position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.15); transition:.2s; border-radius:999px;
}
.slider:before{
  position:absolute; content:""; height:20px; width:20px; left:3px; top:3px;
  background:white; transition:.2s; border-radius:50%;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}
.switch input:checked + .slider{ background: rgba(220,38,38,0.75); }
.switch input:checked + .slider:before{ transform: translateX(18px); }


/* ===== UI20 OVERRIDES ===== */

.ui20-popup-toggle-row{display:flex; justify-content:flex-end; margin: 6px 0 10px;}
.ui20-toggle{display:flex; align-items:center; gap:8px; font-size:12px; color: var(--text-tertiary);}
.ui20-toggle input{width:16px; height:16px;}

.section-date-click{cursor:pointer; text-decoration: underline dotted rgba(0,0,0,0.25); text-underline-offset: 4px;}
/* Fault section: value area wider on narrow screens */
.fault-section .detail-row{gap: 10px;}
.fault-section .detail-label{flex: 0 0 120px; max-width: 120px;}
.fault-section .detail-value{flex: 1 1 auto; min-width: 0;}
/* Calendar: nearly full width + minimal margins */
.calendar-section{padding: 12px 6px !important;}
.calendar-grid{padding: 12px !important; border-radius: 14px !important;}
.days-grid{gap: 2px !important;}
.day-cell{border: 1px solid rgba(0,0,0,0.08) !important;}
.day-cell.selected{border: 2px solid var(--inbody-red) !important;}

/* UI21: Fix calendar layout (7 columns) - override legacy iOS flex hack */
.days-grid{
  display:grid !important;
  grid-template-columns: repeat(7, 1fr) !important;
  flex-wrap: unset !important;
}
.day-cell{
  flex: none !important;
  width: auto !important;
  aspect-ratio: 1 / 1 !important;
  height: auto !important;
}

</style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-compact">
                <div class="header-left">
                    <div class="app-logo">
                        <div class="logo-title">InBody</div>
                        <div class="logo-subtitle">Customer Service Report</div>
                    </div>
                    <div class="user-compact">
                        <span class="user-name-compact">ê¹€í”„ë¡œ</span>
                        <span class="user-divider">â€¢</span>
                        <span class="user-branch-compact">ì„œìš¸ì§€ì‚¬</span>
                        <span class="role-badge-compact">TECH</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="notice-compact" id="noticeCompact">
                        <div class="notice-compact-header">
                            <span class="notice-icon-compact">ğŸ“¢</span>
                            <span class="notice-title-compact">HQ CS ê³µì§€</span>
                            <button class="notice-toggle-btn" id="noticeToggleBtn" onclick="toggleNotice()">
                                <span id="noticeToggleIcon">ğŸ”¼</span>
                            </button>
                        </div>
                        <div class="notice-compact-content" id="noticeContent">
                            <div class="notice-text-compact">
                                3ì›” ì •ê¸° ì ê²€ ì¼ì • ì•ˆë‚´: 3/15(ê¸ˆ) 09:00-18:00 ë³¸ì‚¬ ì‹œìŠ¤í…œ ì ê²€ìœ¼ë¡œ ì¸í•´ ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </div>
                            <div class="notice-period-compact">ğŸ“… 2026.03.01 - 2026.03.31</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Search and Filter -->
        <section class="search-section">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="searchInput" placeholder="ë¬¸ì„œë²ˆí˜¸, ì œí’ˆëª…, S/N, ìƒí˜¸ëª…ìœ¼ë¡œ ê²€ìƒ‰" oninput="applyFilters()">
            </div>
            <!-- Redesigned Filter Chips -->
            <div class="filter-chips">
                <!-- Level 1: ì „ì²´ -->
                <div class="filter-chip-all active" data-filter="ì „ì²´" onclick="selectFilter(this)">ì „ì²´</div>
                <!-- Divider -->
                <div class="filter-divider"></div>
                <!-- Level 2: Sub categories -->
                <div class="filter-chips-sub">
                    <div class="filter-chip-sub" data-filter="ë°©ë¬¸" onclick="selectFilter(this)">ë°©ë¬¸</div>
                    <div class="filter-chip-sub" data-filter="ì›ê²©" onclick="selectFilter(this)">ì›ê²©</div>
                    <div class="filter-chip-sub" data-filter="ì…ê³ " onclick="selectFilter(this)">ì…ê³ </div>
                    <div class="filter-chip-sub" data-filter="íƒë°°" onclick="selectFilter(this)">íƒë°°</div>
                    <div class="filter-chip-sub" data-filter="ìˆ˜ê±°" onclick="selectFilter(this)">ìˆ˜ê±°</div>
                </div>
            </div>
        </section>

        <!-- Calendar Section -->
        <section class="calendar-section">
            <div class="calendar-header">
                <div class="month-selector">
                    <button class="nav-button" onclick="changeMonth(-1)">â€¹</button>
                    <div class="current-month" onclick="showMonthPicker()">
                        <span id="currentMonth">2026ë…„ 2ì›”</span>
                    </div>
                    <button class="nav-button" onclick="changeMonth(1)">â€º</button>
                </div>
                <button class="today-button" onclick="goToToday()">ì˜¤ëŠ˜</button>
            </div>
            <div class="calendar-legend" id="calendarLegend"></div>
            <div class="calendar-grid">
                <div class="weekdays">
                    <div class="weekday sunday">ì¼</div>
                    <div class="weekday">ì›”</div>
                    <div class="weekday">í™”</div>
                    <div class="weekday">ìˆ˜</div>
                    <div class="weekday">ëª©</div>
                    <div class="weekday">ê¸ˆ</div>
                    <div class="weekday saturday">í† </div>
                </div>
                <div class="days-grid" id="daysGrid"></div>
            </div>
        </section>

        <!-- Schedule List -->
        <section class="schedule-section" id="scheduleSection">
            <div class="section-title">
                <span>ğŸ“‹</span>
                <span>ìŠ¤ì¼€ì¤„ ëª©ë¡</span>
                <span class="section-date section-date-click" id="selectedDateText" onclick="openSelectedDayPopup()"></span>
            </div>
            <div id="scheduleList"></div>
        </section>
    </div>

    <!-- Bottom Tab Bar -->
    <nav class="ui17-tabbar" aria-label="í•˜ë‹¨ ë©”ë‰´">
        <button class="ui17-tab active" data-tab="schedule" onclick="showTab('schedule')">
            <div class="ui17-tab-top">CAL</div>
            <div class="ui17-tab-sub">ìŠ¤ì¼€ì¥´</div>
        </button>
        <button class="ui17-tab" data-tab="new" onclick="showTab('new')">
            <div class="ui17-tab-top">NEW</div>
            <div class="ui17-tab-sub">ì‹ ê·œì ‘ìˆ˜</div>
        </button>
        <button class="ui17-tab" data-tab="cs" onclick="showTab('cs')">
            <div class="ui17-tab-top">CS</div>
            <div class="ui17-tab-sub">CSë¬¸ì˜</div>
        </button>
    </nav>

    <!-- Modal Container -->

    <div id="modalContainer"></div>

    <!-- Hidden file inputs -->
    <input type="file" id="photoInput" class="hidden-file-input" accept="image/*" capture="camera" onchange="handlePhotoUpload(event)">
    <input type="file" id="equipmentBarcodeInput" class="hidden-file-input" accept="image/*" capture="camera" onchange="handleEquipmentBarcode(event)">
    <input type="file" id="qrInput" class="hidden-file-input" accept="image/*" capture="camera" onchange="handleQRScan(event)">

    <script>
// ===== AS FIELD APP - APP.JS =====
// InBody Customer Service Field Console

// ===== NOTICE TOGGLE =====
let noticeExpanded = true;
function toggleNotice() {
    noticeExpanded = !noticeExpanded;
    const content = document.getElementById('noticeContent');
    const icon = document.getElementById('noticeToggleIcon');
    if (noticeExpanded) { content.style.display = 'block'; icon.textContent = 'ğŸ”¼'; }
    else { content.style.display = 'none'; icon.textContent = 'ğŸ”½'; }
}

// ===== DATA =====
const technicians = [
    { id: 1, name: 'ê¹€í”„ë¡œ', color: '#9A2A2A' },
    { id: 2, name: 'ì´í”„ë¡œ', color: '#D97706' },
    { id: 3, name: 'ë°•í”„ë¡œ', color: '#059669' },
    { id: 4, name: 'ìµœí”„ë¡œ', color: '#2563EB' },
    { id: 5, name: 'ì •í”„ë¡œ', color: '#7C3AED' }
];

const DEVICE_TYPES = {
    'ì¸ë°”ë””': { cls: 'db-inbody', dcls: 'dc-inbody', icon: '' },
    'ì‹ ì¥ê³„': { cls: 'db-height', dcls: 'dc-height', icon: '' },
    'í˜ˆì••ê³„': { cls: 'db-bp',     dcls: 'dc-bp',     icon: '' },
    'ê¸°íƒ€':   { cls: 'db-other',  dcls: 'dc-other',  icon: 'ğŸ”§' }
};


/* Day popup is always enabled (toggle UI removed) */
function isDayPopupEnabled(){ return true; }

function getDeviceInfo(type) { return DEVICE_TYPES[type] || DEVICE_TYPES['ê¸°íƒ€']; }

const defectDB = {
    'ì¸¡ì •ê°’ì´ìƒ': ['ì²´ì¤‘ê°’ì´ìƒ', 'ì¸¡ì •ì—ëŸ¬(ì¬ì¸¡ì • ë©”ì‹œì§€)', 'ì„í”¼ë˜ìŠ¤ ì˜¤ë¥˜'],
    'ì™¸ë¶€í†µì‹ ': ['WiFi ì—°ê²° ì‹¤íŒ¨', 'WiFi ëŠê¹€', 'Bluetooth í˜ì–´ë§ ì‹¤íŒ¨', 'Bluetooth ëŠê¹€'],
    'í™”ë©´í„°ì¹˜': ['í„°ì¹˜ ë¶ˆëŸ‰', 'ì˜¤ì…ë ¥', 'í™”ë©´ ë©ˆì¶¤'],
    'ì „ì›ë¬¸ì œ': ['ì „ì› ì•ˆì¼œì§', 'ë°°í„°ë¦¬ ê¸‰ë°©ì „', 'ì¶©ì „ ë¶ˆëŸ‰'],
    'ì¥ë¹„ë™ì‘ì´ìƒ': ['ë‚ ì§œ/ì‹œê°„ ì˜¤ë¥˜', 'DB ì €ì¥ ì˜¤ë¥˜', 'ì¸¡ì • ì‹œì‘ ì•ˆë¨'],
    'í”„ë¦°í„°': ['ì¸ì‡„ ì•ˆë¨', 'ì¸ì‡„ íë¦¼', 'ìš©ì§€ ê±¸ë¦¼'],
    'ë²„íŠ¼ë¬¸ì œ': ['ë²„íŠ¼ ì…ë ¥ ë¶ˆëŸ‰', 'ë²„íŠ¼ ëˆŒë¦¼ ê°ë„ ì €í•˜']
};

const serviceResultDB = {
    'ì ê²€ì™„ë£Œ': ['ë¶€í’ˆë¯¸êµì²´', 'ë¶€í’ˆêµì²´', 'ì†Œí”„íŠ¸ì›¨ì–´ ì—…ë°ì´íŠ¸', 'ì„¤ì • ë³€ê²½'],
    'ì¬ë°©ë¬¸í•„ìš”': ['ë¶€í’ˆ ë°œì£¼ í•„ìš”', 'ì¶”ê°€ ì ê²€ í•„ìš”', 'ì „ë¬¸ê°€ íˆ¬ì… í•„ìš”'],
    'íšŒìˆ˜': ['ìˆ˜ë¦¬ ë¶ˆê°€', 'êµí™˜ í•„ìš”', 'ì—…ê·¸ë ˆì´ë“œ ê¶Œì¥'],
    'ê¸°íƒ€': ['ì›ê²©ì§€ì›ì™„ë£Œ', 'ê³ ê°ì·¨ì†Œ', 'ë¶€ì¬ì¤‘']
};

// ì²˜ë¦¬ë°©ë²• ê°€ì´ë“œ DB (ë¶ˆëŸ‰ ì†Œë¶„ë¥˜ â†’ ê°€ì´ë“œ)
const guideDB = {
    'ë°°í„°ë¦¬ ê¸‰ë°©ì „': {
        summary: 'ë°°í„°ë¦¬ ê¸‰ì† ë°©ì „ ì²˜ë¦¬ ê°€ì´ë“œ',
        items: [
            { title: 'ë‚´ìš© ë° ì„¤ê³„ë³€ê²½', content: 'ë°°í„°ë¦¬ ì…€ ë¶ˆëŸ‰ìœ¼ë¡œ ì¸í•œ ê¸‰ë°©ì „. 2024ë…„ 3ì›” ì´í›„ ìƒì‚°ë¶„ì€ ì‹ ê·œ ë°°í„°ë¦¬ íŒ©(v2)ìœ¼ë¡œ ì„¤ê³„ ë³€ê²½ë¨.' },
            { title: 'í•„ìš”ìì¬(ì‚¬ì§„)', content: 'ë°°í„°ë¦¬ íŒ© BATT-INB-770-V2 / ë°°í„°ë¦¬ ì»¤ë„¥í„° CNT-BATT-02', media: true },
            { title: 'ìì¬ í˜¸í™˜ì—¬ë¶€', content: 'InBody 770 (S/N: SN-770-2023-XXX ì´ìƒ) í˜¸í™˜. ê·¸ ì´ì „ ëª¨ë¸ì€ V1 ë°°í„°ë¦¬ íŒ© ì‚¬ìš©.' },
            { title: 'ìì¬ ìƒì‚° ì ìš©ì‹œì ', content: '2024ë…„ 3ì›” 15ì¼ ì´í›„ ìƒì‚°ë¶„ë¶€í„° ì ìš©', tags: ['2024-03-15~'] },
            { title: 'ë¶„í•´ì¡°ë¦½ì˜ìƒ', content: 'ë°°í„°ë¦¬ êµì²´ ì˜ìƒ (15ë¶„)', media: true, isVideo: true },
            { title: 'ë©”ë‰´ì–¼ ê¸°ë°˜ í•„ìˆ˜ ì ê²€ í•­ëª©', content: 'â‘  ì¶©ì „ ë‹¨ì ìƒíƒœ í™•ì¸\nâ‘¡ ë°°í„°ë¦¬ íŒ½ì°½ ì—¬ë¶€ í™•ì¸\nâ‘¢ ì „ì› íšŒë¡œ ì „ì•• ì²´í¬\nâ‘£ íŒì›¨ì–´ ë²„ì „ ìµœì‹  ì—¬ë¶€ í™•ì¸', tags: ['ì „ì›íšŒë¡œ', 'ë°°í„°ë¦¬', 'íŒì›¨ì–´'] }
        ]
    },
    'ì²´ì¤‘ê°’ì´ìƒ': {
        summary: 'ì²´ì¤‘ ì´ìƒê°’ ì²˜ë¦¬ ê°€ì´ë“œ',
        items: [
            { title: 'ë‚´ìš© ë° ì„¤ê³„ë³€ê²½', content: 'ë¡œë“œì…€ ë¶ˆëŸ‰ ë˜ëŠ” ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì˜¤ë¥˜. v3.1 ì´í›„ ìë™ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê¸°ëŠ¥ ì¶”ê°€.' },
            { title: 'í•„ìš”ìì¬(ì‚¬ì§„)', content: 'ë¡œë“œì…€ ì…‹ LOAD-CELL-SET-01', media: true },
            { title: 'ìì¬ í˜¸í™˜ì—¬ë¶€', content: 'InBody 270/370/570/770 ê³µí†µ ì ìš© ê°€ëŠ¥.' },
            { title: 'ìì¬ ìƒì‚° ì ìš©ì‹œì ', content: '2023ë…„ 6ì›” 1ì¼ ì´í›„ ìƒì‚°ë¶„', tags: ['2023-06-01~'] },
            { title: 'ë¶„í•´ì¡°ë¦½ì˜ìƒ', content: 'ë¡œë“œì…€ êµì²´ ì˜ìƒ (25ë¶„)', media: true, isVideo: true },
            { title: 'ë©”ë‰´ì–¼ ê¸°ë°˜ í•„ìˆ˜ ì ê²€ í•­ëª©', content: 'â‘  ì˜ì  ìº˜ë¦¬ë¸Œë ˆì´ì…˜ 3íšŒ ë°˜ë³µ\nâ‘¡ í‘œì¤€ì¶”(20kg) ì¸¡ì •ê°’ ì˜¤ì°¨ Â±0.1kg ì´ë‚´ í™•ì¸\nâ‘¢ ë°œíŒ ìˆ˜í‰ ìƒíƒœ í™•ì¸\nâ‘£ ë¡œë“œì…€ ì»¤ë„¥í„° ì²´ê²° í™•ì¸', tags: ['ìº˜ë¦¬ë¸Œë ˆì´ì…˜', 'ë¡œë“œì…€', 'ìˆ˜í‰'] }
        ]
    },
    'ìš©ì§€ ê±¸ë¦¼': {
        summary: 'í”„ë¦°í„° ìš©ì§€ ê±¸ë¦¼ ì²˜ë¦¬ ê°€ì´ë“œ',
        items: [
            { title: 'ë‚´ìš© ë° ì„¤ê³„ë³€ê²½', content: 'í”„ë¦°í„° ë¡¤ëŸ¬ ë§ˆëª¨ ë˜ëŠ” ìš©ì§€ ê·œê²© ë¶ˆì¼ì¹˜. ì‹ ê·œ ë¡¤ëŸ¬ í‚¤íŠ¸ ì¶œì‹œ (2025ë…„ 1ì›”).' },
            { title: 'í•„ìš”ìì¬(ì‚¬ì§„)', content: 'í”„ë¦°í„° ë¡¤ëŸ¬ í‚¤íŠ¸ PRINT-ROLLER-KIT-03', media: true },
            { title: 'ìì¬ í˜¸í™˜ì—¬ë¶€', content: 'InBody 570/770 í”„ë¦°í„° ë‚´ì¥ ëª¨ë¸ ê³µí†µ ì ìš©.' },
            { title: 'ìì¬ ìƒì‚° ì ìš©ì‹œì ', content: '2025ë…„ 1ì›” 10ì¼ ì´í›„', tags: ['2025-01-10~'] },
            { title: 'ë¶„í•´ì¡°ë¦½ì˜ìƒ', content: 'í”„ë¦°í„° ë¡¤ëŸ¬ êµì²´ ì˜ìƒ (10ë¶„)', media: true, isVideo: true },
            { title: 'ë©”ë‰´ì–¼ ê¸°ë°˜ í•„ìˆ˜ ì ê²€ í•­ëª©', content: 'â‘  ìš©ì§€ ê·œê²© í™•ì¸ (57mm Ã— 40m ì—´ì „ì‚¬ì§€)\nâ‘¡ ë¡¤ëŸ¬ í‘œë©´ ì´ë¬¼ì§ˆ ì œê±°\nâ‘¢ ìš©ì§€ ì¥ì°© ë°©í–¥ í™•ì¸\nâ‘£ ì¸ì‡„ í…ŒìŠ¤íŠ¸ 5íšŒ ë°˜ë³µ', tags: ['ìš©ì§€ê·œê²©', 'ë¡¤ëŸ¬', 'ì¸ì‡„í…ŒìŠ¤íŠ¸'] }
        ]
    }
};

// ë‹¤ë¥¸ ASê¸°ì‚¬ ì²˜ë¦¬ ì‚¬ë¡€ DB (ë¶ˆëŸ‰ ì†Œë¶„ë¥˜ â†’ ì²˜ë¦¬ ì‚¬ë¡€)
const peerCaseDB = {
    'ë°°í„°ë¦¬ ê¸‰ë°©ì „': [
        { tech: 'ì´í”„ë¡œ', date: '2026-01-22', product: 'InBody 770', result: 'ë°°í„°ë¦¬ íŒ©(V2) êµì²´ í›„ ì •ìƒ. ì¶©ì „ ì–´ëŒ‘í„°ë„ í•¨ê»˜ êµì²´. ì‘ì—…ì‹œê°„ ì•½ 40ë¶„.', tags: ['ë°°í„°ë¦¬êµì²´', 'V2íŒ©'] },
        { tech: 'ë°•í”„ë¡œ', date: '2025-12-10', product: 'InBody 570', result: 'íŒì›¨ì–´ ì—…ë°ì´íŠ¸(v3.2â†’v3.3)ë¡œ ë°°í„°ë¦¬ ê´€ë¦¬ ë¡œì§ ê°œì„ . êµì²´ ì—†ì´ í•´ê²°. ì¬ë°©ë¬¸ ë¶ˆí•„ìš”.', tags: ['íŒì›¨ì–´ì—…ë°ì´íŠ¸', 'ë¬´êµì²´'] },
        { tech: 'ìµœí”„ë¡œ', date: '2025-11-05', product: 'InBody 270', result: 'ì „ì› íšŒë¡œ PCB ë¶ˆëŸ‰ìœ¼ë¡œ PCB êµì²´. ë¶€í’ˆ ë°œì£¼ í›„ ì¬ë°©ë¬¸ ì²˜ë¦¬.', tags: ['PCBêµì²´', 'ì¬ë°©ë¬¸'] }
    ],
    'ì²´ì¤‘ê°’ì´ìƒ': [
        { tech: 'ë°•í”„ë¡œ', date: '2026-01-15', product: 'InBody 770', result: 'ë¡œë“œì…€ #3 ë¶ˆëŸ‰. ë¡œë“œì…€ ì„¸íŠ¸ êµì²´ + 3íšŒ ìº˜ë¦¬ë¸Œë ˆì´ì…˜. ì˜¤ì°¨ Â±0.05kg ì´ë‚´ë¡œ ì •ìƒí™”.', tags: ['ë¡œë“œì…€êµì²´', 'ìº˜ë¦¬ë¸Œë ˆì´ì…˜'] },
        { tech: 'ì •í”„ë¡œ', date: '2025-12-20', product: 'BPBIO320', result: 'ë°œíŒ ìˆ˜í‰ ë¯¸ì¡°ì • ì›ì¸. ìˆ˜í‰ ì¡°ì • ë° ì˜ì  ìº˜ë¦¬ë¸Œë ˆì´ì…˜ìœ¼ë¡œ í•´ê²°. ë¶€í’ˆ êµì²´ ì—†ìŒ.', tags: ['ìˆ˜í‰ì¡°ì •', 'ì˜ì ë³´ì •'] }
    ],
    'ìš©ì§€ ê±¸ë¦¼': [
        { tech: 'ì´í”„ë¡œ', date: '2026-01-30', product: 'BSM-170', result: 'ë¡¤ëŸ¬ ë§ˆëª¨ â†’ ë¡¤ëŸ¬ í‚¤íŠ¸ êµì²´. 57mm ì •í’ˆ ìš©ì§€ë¡œ ë³€ê²½ ì•ˆë‚´. ì´í›„ ì •ìƒ ì¶œë ¥.', tags: ['ë¡¤ëŸ¬êµì²´', 'ì •í’ˆìš©ì§€'] },
        { tech: 'ê¹€í”„ë¡œ', date: '2025-12-05', product: 'InBody 770', result: 'ìš©ì§€ ë¹„ê·œê²© ì‚¬ìš© ì›ì¸. ì •í’ˆ ìš©ì§€ë¡œ êµì²´ í›„ í•´ê²°. ìš©ì§€ ê·œê²© ì•ˆë‚´ì„œ ë¶€ì°©.', tags: ['ìš©ì§€êµì²´', 'ì•ˆë‚´ë¶€ì°©'] }
    ],
    'í„°ì¹˜ ë¶ˆëŸ‰': [
        { tech: 'ìµœí”„ë¡œ', date: '2026-02-01', product: 'InBody 570', result: 'í„°ì¹˜ íŒ¨ë„ ì¼€ì´ë¸” ì ‘ì´‰ ë¶ˆëŸ‰. ì»¤ë„¥í„° ì¬ì²´ê²°ë¡œ í•´ê²°. 5ë¶„ ì‘ì—….', tags: ['ì¼€ì´ë¸”ì¬ì²´ê²°', 'ê°„ë‹¨ìˆ˜ë¦¬'] },
        { tech: 'ì •í”„ë¡œ', date: '2025-11-18', product: 'InBody 770', result: 'í„°ì¹˜ íŒ¨ë„ ìì²´ ë¶ˆëŸ‰. íŒ¨ë„ êµì²´ í•„ìš”. ë¶€í’ˆ ë°œì£¼ í›„ ì¬ë°©ë¬¸.', tags: ['íŒ¨ë„êµì²´', 'ì¬ë°©ë¬¸'] }
    ],
    'WiFi ì—°ê²° ì‹¤íŒ¨': [
        { tech: 'ë°•í”„ë¡œ', date: '2026-01-08', product: 'InBody 770', result: 'IP ì¶©ëŒ ì›ì¸. ê³ ì • IP ì„¤ì •ìœ¼ë¡œ ë³€ê²½. WiFi ëª¨ë“ˆ ì •ìƒ.', tags: ['IPì„¤ì •ë³€ê²½'] },
        { tech: 'ì´í”„ë¡œ', date: '2025-12-28', product: 'BSM-170', result: 'WiFi ëª¨ë“ˆ ë¶ˆëŸ‰. ëª¨ë“ˆ êµì²´ í›„ ì •ìƒ ì—°ê²° í™•ì¸.', tags: ['WiFiëª¨ë“ˆêµì²´'] }
    ]
};


const checklistDB = {
    'ë°°í„°ë¦¬ ê¸‰ë°©ì „': [
        'ì¶©ì „ ì¼€ì´ë¸” ë° ì–´ëŒ‘í„° ì •ìƒ ì—¬ë¶€ í™•ì¸',
        'ë°°í„°ë¦¬ íŒ½ì°½ ë˜ëŠ” ë³€í˜• í™•ì¸',
        'ë°°í„°ë¦¬ ì”ëŸ‰ í‘œì‹œ ì •í™•ì„± í™•ì¸',
        'ì „ì› íšŒë¡œ ì „ì•• ì¸¡ì • (ì •ìƒë²”ìœ„: 11.1V~12.6V)',
        'ë°°í„°ë¦¬ êµì²´ í›„ 100% ì¶©ì „ í…ŒìŠ¤íŠ¸',
        'ë°©ì „ ì‹œê°„ ì¸¡ì • (ì •ìƒ: 8ì‹œê°„ ì´ìƒ)'
    ],
    'ì²´ì¤‘ê°’ì´ìƒ': [
        'ë°œíŒ ìˆ˜í‰ ìƒíƒœ í™•ì¸',
        'ì˜ì  ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ìˆ˜í–‰',
        'í‘œì¤€ì¶” 20kg ê¸°ì¤€ ì˜¤ì°¨ Â±0.1kg ì´ë‚´ í™•ì¸',
        'ë¡œë“œì…€ ì»¤ë„¥í„° ì²´ê²° ìƒíƒœ í™•ì¸',
        'ì¸¡ì • í™˜ê²½ (ì§„ë™, ê²½ì‚¬) í™•ì¸',
        '3íšŒ ë°˜ë³µ ì¸¡ì • ì˜¤ì°¨ í™•ì¸'
    ],
    'ìš©ì§€ ê±¸ë¦¼': [
        'ìš©ì§€ ê·œê²© í™•ì¸ (57mm Ã— 40m)',
        'ë¡¤ëŸ¬ ì´ë¬¼ì§ˆ ì œê±°',
        'ìš©ì§€ ì¥ì°© ë°©í–¥ í™•ì¸',
        'í”„ë¦°í„° ì»¤ë²„ ì ê¸ˆ ìƒíƒœ í™•ì¸',
        'ì¸ì‡„ í…ŒìŠ¤íŠ¸ 5íšŒ ìˆ˜í–‰',
        'ìš©ì§€ ì”ëŸ‰ í™•ì¸'
    ],
    'í„°ì¹˜ ë¶ˆëŸ‰': [
        'í™”ë©´ í‘œë©´ ì´ë¬¼ì§ˆÂ·ì˜¤ì—¼ í™•ì¸',
        'í„°ì¹˜ íŒ¨ë„ ì¼€ì´ë¸” ì²´ê²° í™•ì¸',
        'í„°ì¹˜ ë³´ì • ì‹¤í–‰',
        'ë°˜ì‘ ì˜ì—­ ì „ì²´ í…ŒìŠ¤íŠ¸',
        'í™”ë©´ êµì²´ í•„ìš” ì—¬ë¶€ íŒë‹¨'
    ],
    'WiFi ì—°ê²° ì‹¤íŒ¨': [
        'AP ì ‘ì† ì •ë³´ í™•ì¸ (SSID, ë¹„ë°€ë²ˆí˜¸)',
        'ì‹ í˜¸ ê°•ë„ í™•ì¸ (-70dBm ì´ìƒ)',
        'IP ì„¤ì • í™•ì¸ (DHCP ë˜ëŠ” ê³ ì •IP)',
        'ë°©í™”ë²½ í¬íŠ¸ ì„¤ì • í™•ì¸',
        'ì¬ì—°ê²° 3íšŒ í…ŒìŠ¤íŠ¸'
    ]
};

// ì €ì¥ëœ ì¶œë°œì§€ ëª©ë¡
let savedOrigins = ['ë³¸ì‚¬(ì„œìš¸ ê°•ë‚¨)', 'ì„œìš¸ì§€ì‚¬', 'ë¶€ì‚°ì§€ì‚¬'];

let sampleSchedules = [
    {
        docNo: 'DOC-20260214-001',
        company: 'ì„œìš¸ë‚´ê³¼ì˜ì›',
        address: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123',
        phone: '02-1234-5678',
        receivedAt: '2026-02-14',
        visitPlannedAt: '2026-02-14',
        visitRequestTime: '09:30',
        deviceType: 'ì¸ë°”ë””',
        product: 'InBody 770',
        version: 'v3.2.1',
        mfgDate: '2023-05-10',
        deliveryDate: '2023-06-01',
        serial: 'SN-770-2023-001',
        faultMajor: 'ì „ì›ë¬¸ì œ',
        faultMinor: 'ë°°í„°ë¦¬ ê¸‰ë°©ì „',
        receiptContent: 'ë°°í„°ë¦¬ê°€ ë¹ ë¥´ê²Œ ì†Œëª¨ë˜ë©°, ì¶©ì „ í›„ì—ë„ 1-2ì‹œê°„ ë‚´ ë°©ì „ë¨',
        branch: 'ì„œìš¸ì§€ì‚¬',
        visitor: 'ê¹€í”„ë¡œ',
        visitorId: 1,
        prevAction: 'ì´ˆê¸° ì ê²€ í•„ìš”. ì „ì› ì—°ê²° í™•ì¸ ìš”ì²­.',
        method: 'ë°©ë¬¸',
        status: 'ëŒ€ê¸°',
        savedReport: null
    },
    {
        docNo: 'DOC-20260214-002',
        company: 'í–‰ë³µí•œë³‘ì›',
        address: 'ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 456',
        phone: '02-2345-6789',
        receivedAt: '2026-02-13',
        visitPlannedAt: '2026-02-14',
        visitRequestTime: '14:00',
        deviceType: 'ì‹ ì¥ê³„',
        product: 'BSM-170',
        version: 'v2.1.0',
        mfgDate: '2024-01-15',
        deliveryDate: '2024-02-01',
        serial: 'BSM-170-2024-045',
        faultMajor: 'í”„ë¦°í„°',
        faultMinor: 'ìš©ì§€ ê±¸ë¦¼',
        receiptContent: 'í”„ë¦°í„° ìš©ì§€ê°€ ìì£¼ ê±¸ë¦¼. ì¶œë ¥ë¬¼ì´ ì°¢ì–´ì ¸ ë‚˜ì˜´',
        branch: 'ì„œìš¸ì§€ì‚¬',
        visitor: 'ì´í”„ë¡œ',
        visitorId: 2,
        prevAction: 'í”„ë¦°í„° í—¤ë“œ ì²­ì†Œ í•„ìš”',
        method: 'ë°©ë¬¸',
        status: 'ì§„í–‰ì¤‘',
        savedReport: null
    },
    {
        docNo: 'DOC-20260214-003',
        company: 'ê±´ê°•ê²€ì§„ì„¼í„°',
        address: 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆëŒ€ë¡œ 789',
        phone: '02-3456-7890',
        receivedAt: '2026-02-14',
        visitPlannedAt: '2026-02-14',
        visitRequestTime: '16:30',
        deviceType: 'í˜ˆì••ê³„',
        product: 'BPBIO320',
        version: 'v1.8.9',
        mfgDate: '2025-11-20',
        deliveryDate: '2025-12-01',
        serial: 'BP-320-2025-199',
        faultMajor: 'ì¸¡ì •ê°’ì´ìƒ',
        faultMinor: 'ì²´ì¤‘ê°’ì´ìƒ',
        receiptContent: 'ì²´ì¤‘ ì¸¡ì •ê°’ì´ ì‹¤ì œì™€ 5kg ì´ìƒ ì°¨ì´ë‚¨',
        branch: 'ì„œìš¸ì§€ì‚¬',
        visitor: 'ê¹€í”„ë¡œ',
        visitorId: 1,
        prevAction: 'ì„¼ì„œ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í•„ìš”',
        method: 'ë°©ë¬¸',
        status: 'ëŒ€ê¸°',
        savedReport: null
    }
];

let csInquiries = [
    {
        id: 'INQ-20260201',
        date: '2026-02-01',
        title: 'InBody 770 íŒì›¨ì–´ ì—…ë°ì´íŠ¸ ë¬¸ì˜',
        priority: 'high',
        model: 'InBody 770',
        serial: 'SN-770-2023-001',
        content: 'ìµœì‹  íŒì›¨ì–´ ë²„ì „ê³¼ ì—…ë°ì´íŠ¸ ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”.',
        photos: [],
        hqResponse: 'ìµœì‹  íŒì›¨ì–´ v3.3.0ì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸ ë°©ë²•ì€ ì²¨ë¶€ëœ ë§¤ë‰´ì–¼ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”.'
    }
];

let schedules = [...sampleSchedules];
let currentDate = new Date(2026, 1, 14);
let selectedDate = new Date(2026, 1, 14);
let currentSchedule = null;
let isRevisitScheduled = false;
let currentFilter = 'ì „ì²´';
let materials = [];
let uploadedPhotos = [];
let currentScheduleFilter = 'all';
let currentCheckedItems = [];

// ===== INITIALIZATION =====
function init() {
    renderLegend();
    renderCalendar();
    renderSchedules();
    setActiveTab('schedule');
}

// ===== Bottom Tab Bar =====
function setActiveTab(tabName){
    document.querySelectorAll('.ui17-tab').forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.tab === tabName);
    });
}
function showTab(tabName){
    setActiveTab(tabName);
    if(tabName==='schedule'){
        const el = document.getElementById('scheduleSection');
        if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
        return;
    }
    if(tabName==='new'){
        if(typeof showNewSchedule==='function'){ showNewSchedule(); }
        return;
    }
    if(tabName==='cs'){
        if(typeof showCSInquiry==='function'){ showCSInquiry(); }
        return;
    }
}

function renderLegend() {
    const legend = document.getElementById('calendarLegend');
    legend.innerHTML = technicians.map(tech => `
        <div class="legend-item">
            <div class="legend-dot" style="background:${tech.color}"></div>
            <span>${tech.name}</span>
        </div>
    `).join('');
}

// ===== FILTER CHIPS =====
function selectFilter(chip) {
    document.querySelectorAll('[data-filter]').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    currentFilter = chip.dataset.filter;
    applyFilters();
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    schedules = sampleSchedules.filter(s => {
        const matchesSearch = !searchTerm ||
            s.docNo.toLowerCase().includes(searchTerm) ||
            s.company.toLowerCase().includes(searchTerm) ||
            s.product.toLowerCase().includes(searchTerm) ||
            s.serial.toLowerCase().includes(searchTerm);
        const matchesFilter = currentFilter === 'ì „ì²´' || s.method === currentFilter;
        return matchesSearch && matchesFilter;
    });
    renderCalendar();
    renderSchedules();
}

// ===== CALENDAR =====
function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    document.getElementById('currentMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    const prevLastDate = new Date(year, month, 0).getDate();
    const daysGrid = document.getElementById('daysGrid');
    daysGrid.innerHTML = '';
    for (let i = firstDay - 1; i >= 0; i--) {
        daysGrid.appendChild(createDayCell(prevLastDate - i, 'other-month', new Date(year, month - 1, prevLastDate - i)));
    }
    for (let day = 1; day <= lastDate; day++) {
        const date = new Date(year, month, day);
        const isToday = isSameDay(date, new Date(2026, 1, 14));
        const isSelected = isSameDay(date, selectedDate);
        const daySchedules = getSchedulesForDate(date);
        let classes = [];
        if (isToday) classes.push('today');
        if (isSelected) classes.push('selected');
        if (daySchedules.length > 0) classes.push('has-schedule');
        daysGrid.appendChild(createDayCell(day, classes.join(' '), date, daySchedules));
    }
    const totalCells = daysGrid.children.length;
    for (let day = 1; day <= 42 - totalCells; day++) {
        daysGrid.appendChild(createDayCell(day, 'other-month', new Date(year, month + 1, day)));
    }
}

function createDayCell(day, className, date, daySchedules = []) {
    const cell = document.createElement('div');
    cell.className = `day-cell ${className}`;

    cell.innerHTML = `<span class="day-number">${day}</span>`;

    if (daySchedules.length > 0) {
        const techGroups = {};
        daySchedules.forEach(s => {
            const key = s.visitorId ?? s.visitor ?? s.technicianId ?? s.techId ?? 'unknown';
            if (!techGroups[key]) techGroups[key] = [];
            techGroups[key].push(s);
        });

        const schedulesWrap = document.createElement('div');
        schedulesWrap.className = 'day-schedules';

        Object.keys(techGroups).forEach(techId => {
            const tech = technicians.find(t => String(t.id) === String(techId) || t.name === techId);
            const item = document.createElement('div');
            item.className = 'day-schedule-item';
            item.innerHTML = `
                <div class="day-schedule-dot" style="background:${tech ? tech.color : 'rgba(0,0,0,0.18)'}"></div>
                <span class="day-schedule-name">${tech ? tech.name : String(techId)}</span>
                <span class="day-schedule-count">(${techGroups[techId].length})</span>
            `;

            const dateStr = formatDate(date);
            const open = (e) => {
                e.stopPropagation();
                // ê±´ìˆ˜ í´ë¦­ â†’ íŒì—…(ìŠ¤ì¼€ì¥´ ëª©ë¡)
                openDayPopup(dateStr, techGroups[techId], tech ? tech.name : null);
            };
            item.addEventListener('click', open);
            schedulesWrap.appendChild(item);
        });

        cell.appendChild(schedulesWrap);
    }

    // ë‚ ì§œ í´ë¦­ì€ ì„ íƒë§Œ
    if (!className.includes('other-month')) cell.onclick = () => handleDayClick(date);
    return cell;
}

function selectDate(date) { selectedDate = date; renderCalendar(); renderSchedules(); }

// ìº˜ë¦°ë”ì—ì„œ ë‚ ì§œë¥¼ ëˆŒë €ì„ ë•Œ: ìŠ¤ì¼€ì¤„ì´ ìˆìœ¼ë©´ ê·¸ë‚  ìŠ¤ì¼€ì¤„ì„ íŒì—…ìœ¼ë¡œ ë³´ì—¬ì¤Œ
function handleDayClick(date){
  // ë‚ ì§œ í´ë¦­: ì„ íƒë§Œ (íŒì—…ì€ 'ê±´ìˆ˜' í´ë¦­)
  selectDate(date);
}



function openSelectedDayPopup(){
    const dateStr = formatDate(selectedDate);
    let daySchedules = schedules.filter(s => s.visitPlannedAt === dateStr);
    if (currentScheduleFilter !== 'all') daySchedules = daySchedules.filter(s => s.visitor === currentScheduleFilter);
    if (!isDayPopupEnabled()) return;
    if (daySchedules.length === 0) return;
    openDayPopup(dateStr, daySchedules);
}

function getCompanyName(s){
    return s.company ?? s.companyName ?? s.storeName ?? s.client ?? s.customer ?? s.hospital ?? s['ìƒí˜¸ëª…'] ?? s['ê³ ê°ëª…'] ?? '';
}

function openDayPopup(dateStr, daySchedules, techName=null){
    const title = techName ? `${dateStr.replaceAll('-','.')} Â· ${techName}` : `${dateStr.replaceAll('-','.')}`;
    const list = daySchedules
        .slice()
        .sort((a,b)=> (a.visitRequestTime||'').localeCompare(b.visitRequestTime||''))
        .map(s=>{
            const tech = technicians.find(t=> String(t.id)===String(s.visitorId) || t.name===s.visitor);
            const left = tech ? `border-left-color:${tech.color}` : '';
            const statusClass = s.status === 'ëŒ€ê¸°' ? 'status-waiting' : s.status === 'ì§„í–‰ì¤‘' ? 'status-progress' : 'status-complete';
            const company = getCompanyName(s) || '(ìƒí˜¸ëª… ì—†ìŒ)';
            return `
            <div class="schedule-card" style="${left}" onclick="openFromDayPopup('${s.docNo}')">
                <div class="card-header">
                    <div class="card-time">${s.visitRequestTime || ''}</div>
                    <div class="card-header-right">
                        <span class="status-badge ${statusClass}">${s.status || ''}</span>
                        <span class="role-badge-compact" style="background:${tech?tech.color:'rgba(0,0,0,0.08)'};">${s.visitor || (tech?tech.name:'')}</span>
                    </div>
                </div>
                <div class="card-company">${company}</div>
                <div class="card-info">
                    <div class="info-row"><span class="info-label">ì£¼ì†Œ</span><span class="info-value">${s.address || ''}</span></div>
                    <div class="info-row"><span class="info-label">ì¥ë¹„</span><span class="info-value">${s.product || s.deviceType || ''}</span></div>
                    <div class="info-row"><span class="info-label">ë¶ˆëŸ‰</span><span class="info-value">${s.faultMajor || ''}</span></div>
                </div>
            </div>`;
        }).join('');

    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.id = 'dayPopupOverlay';
    overlay.innerHTML = `
      <div class="modal-container day-popup-modal" role="dialog" aria-modal="true">
        <div class="modal-header">
          <h2>${title}</h2>
          <button class="close-btn" onclick="closeModal('dayPopupOverlay')" aria-label="ë‹«ê¸°">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="day-popup-list">${list || '<div class="empty-state">í•´ë‹¹ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>'}</div>
        </div>
      </div>`;
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal('dayPopupOverlay'); });
    document.body.appendChild(overlay);
}

function openFromDayPopup(docNo){
    document.getElementById('modalContainer').innerHTML = '';
    showDetail(docNo);
}

function closeDayPopup(event){
    if(!event || (event.target && event.target.classList && event.target.classList.contains('modal-overlay'))){
        document.getElementById('modalContainer').innerHTML = '';
    }
}

function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); renderCalendar(); }
function goToToday() { currentDate = new Date(2026,1,14); selectedDate = new Date(2026,1,14); renderCalendar(); renderSchedules(); }

function showMonthPicker() {
    const html = `
        <div class="picker-modal active" id="pickerModal" onclick="closePickerModal(event)">
            <div class="picker-content" onclick="event.stopPropagation()">
                <h3 class="picker-title">ì›” ì„ íƒ</h3>
                <div class="picker-grid">
                    ${['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'].map((m,i) =>
                        `<div class="picker-item ${i===currentDate.getMonth()?'selected':''}" onclick="selectMonth(${i})">${m}</div>`
                    ).join('')}
                </div>
            </div>
        </div>`;
    document.getElementById('modalContainer').innerHTML = html;
}
function selectMonth(month) { currentDate.setMonth(month); renderCalendar(); closePickerModal(); }
function closePickerModal(event) {
    if (event && event.target.classList.contains('picker-modal')) document.getElementById('modalContainer').innerHTML = '';
    else if (!event) document.getElementById('modalContainer').innerHTML = '';
}

// ===== SCHEDULE FILTERS WITH ROUTE BUTTON =====
function renderScheduleFilters() {
    const dateStr = formatDate(selectedDate);
    const daySchedules = schedules.filter(s => s.visitPlannedAt === dateStr);
    const techCounts = {};
    daySchedules.forEach(s => {
        if (!techCounts[s.visitor]) techCounts[s.visitor] = 0;
        techCounts[s.visitor]++;
    });
    const totalCount = daySchedules.length;

    // âœ… UI ê°œì„ : "ì „ì²´ë³´ê¸°"ëŠ” 1ì¤„, ASê¸°ì‚¬ ëª©ë¡ì€ ê·¸ ì•„ë˜ ì¤„ë¡œ ë¶„ë¦¬
    let html = `<div class="schedule-filters-wrapper">
        <div class="schedule-filters-stack">
            <div class="schedule-filters-all">
                <button class="schedule-filter-btn ${currentScheduleFilter==='all'?'active':''}" onclick="filterSchedules('all')">ì „ì²´ë³´ê¸° (${totalCount})</button>
            </div>
            <div class="schedule-filters-techs">`;
    Object.keys(techCounts).forEach(visitor => {
        html += `<button class="schedule-filter-btn ${currentScheduleFilter===visitor?'active':''}" onclick="filterSchedules('${visitor}')">${visitor} (${techCounts[visitor]})</button>`;
    });
    html += `</div>
        </div>`;
    if (totalCount > 0) {
        html += `<button class="route-btn" onclick="showRouteModal()">ğŸ—ºï¸ ë£¨íŠ¸</button>`;
    }
    html += `</div>`;

    // í˜„ì¬ í•„í„° ê¸°ì¤€ìœ¼ë¡œ ì¥ë¹„ í˜„í™© ê³„ì‚° (ë‹´ë‹¹ì í•„í„° ë°˜ì˜)
    const filteredSchedules = currentScheduleFilter === 'all'
        ? daySchedules
        : daySchedules.filter(s => s.visitor === currentScheduleFilter);

    const deviceCounts = {};
    filteredSchedules.forEach(s => {
        const dt = s.deviceType || 'ê¸°íƒ€';
        if (!deviceCounts[dt]) deviceCounts[dt] = 0;
        deviceCounts[dt]++;
    });

    if (filteredSchedules.length > 0 && Object.keys(deviceCounts).length > 0) {
        const label = currentScheduleFilter === 'all' ? 'ì˜¤ëŠ˜ ì¥ë¹„ í˜„í™©' : `${currentScheduleFilter} ì¥ë¹„ í˜„í™©`;
        html += `<div class="device-summary-bar"><div class="device-summary-label">${label}</div>`;
        Object.entries(deviceCounts).forEach(([dt, cnt]) => {
            const info = getDeviceInfo(dt);
            html += `<span class="device-chip ${info.dcls}">${info.icon} ${dt} <span class="dc-num">${cnt}ê±´</span></span>`;
        });
        html += `</div>`;
    }
    return html;
}

function filterSchedules(filter) { currentScheduleFilter = filter; renderSchedules(); }

function getSchedulesForDate(date) {
    const dateStr = formatDate(date);
    return schedules.filter(s => s.visitPlannedAt === dateStr);
}

// ===== SCHEDULE RENDER =====
function renderSchedules() {
    const dateStr = formatDate(selectedDate);
    document.getElementById('selectedDateText').textContent = `(${selectedDate.getFullYear()}.${selectedDate.getMonth()+1}.${selectedDate.getDate()})`;
    let daySchedules = schedules.filter(s => s.visitPlannedAt === dateStr);
    if (currentScheduleFilter !== 'all') daySchedules = daySchedules.filter(s => s.visitor === currentScheduleFilter);
    const morning = daySchedules.filter(s => parseInt(s.visitRequestTime.split(':')[0]) < 12).sort((a,b) => a.visitRequestTime.localeCompare(b.visitRequestTime));
    const afternoon = daySchedules.filter(s => parseInt(s.visitRequestTime.split(':')[0]) >= 12).sort((a,b) => a.visitRequestTime.localeCompare(b.visitRequestTime));
    const listHtml = [renderScheduleFilters()];
    if (morning.length > 0) listHtml.push(`<div class="time-section"><div class="time-header">ì˜¤ì „</div>${morning.map(s=>renderScheduleCard(s)).join('')}</div>`);
    if (afternoon.length > 0) listHtml.push(`<div class="time-section"><div class="time-header">ì˜¤í›„</div>${afternoon.map(s=>renderScheduleCard(s)).join('')}</div>`);
    if (daySchedules.length === 0) listHtml.push(`<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">ì´ ë‚ ì§œì— ì˜ˆì •ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤</div></div>`);
    document.getElementById('scheduleList').innerHTML = listHtml.join('');
}

function renderScheduleCard(schedule) {
    const statusClass = schedule.status === 'ëŒ€ê¸°' ? 'status-waiting' : schedule.status === 'ì§„í–‰ì¤‘' ? 'status-progress' : 'status-complete';
    const tech = technicians.find(t => t.id === schedule.visitorId);
    const dt = schedule.deviceType || 'ê¸°íƒ€';
    const info = getDeviceInfo(dt);
    // ìœ ìƒ/ë¬´ìƒ ê³„ì‚°
    const delivDate = new Date(schedule.deliveryDate);
    const recvDate = new Date(schedule.receivedAt);
    const usageDays = Math.floor((recvDate - delivDate) / (1000 * 60 * 60 * 24));
    const warranty = usageDays <= 365 ? 'ë¬´ìƒ' : 'ìœ ìƒ';
    const warrantyStyle = usageDays <= 365
        ? 'background:#D1FAE5;color:#059669;border:1px solid #A7F3D0;'
        : 'background:#FEE2E2;color:#DC2626;border:1px solid #FECACA;';
    return `
        <div class="schedule-card" style="border-left-color:${tech?tech.color:'#ccc'}" onclick="showDetail('${schedule.docNo}')">
            <div class="card-header">
                <div class="card-time">${schedule.visitRequestTime}</div>
                <div class="card-header-right">
                    <span class="device-badge ${info.cls}">${info.icon} ${dt}</span>
                    <span class="status-badge ${statusClass}">${schedule.status}</span>
                </div>
            </div>
            <div class="card-company">${schedule.company}</div>
            <div class="card-info">
                <div class="info-row"><span class="info-label">ë‹´ë‹¹ì</span><span class="info-value">${schedule.visitor}</span></div>
                <div class="info-row"><span class="info-label">ì œí’ˆ</span><span class="info-value">${schedule.product} <span style="font-size:11px;font-weight:700;padding:2px 7px;border-radius:10px;${warrantyStyle}">${warranty}</span></span></div>
                <div class="info-row"><span class="info-label">ë¶ˆëŸ‰êµ¬ë¶„</span><span class="info-value">${schedule.faultMajor} > ${schedule.faultMinor}</span></div>
            </div>
        </div>`;
}

// ===== ROUTE MODAL =====
function showRouteModal() {
    const dateStr = formatDate(selectedDate);
    let daySchedules = schedules.filter(s => s.visitPlannedAt === dateStr);
    if (currentScheduleFilter !== 'all') daySchedules = daySchedules.filter(s => s.visitor === currentScheduleFilter);
    
    const savedOriginsHTML = savedOrigins.map((o,i) =>
        `<div class="origin-tag" data-idx="${i}" onclick="selectOriginTag(this, '${o}')">${o}</div>`
    ).join('');
    
    const stopsHTML = daySchedules.map((s,i) => `
        <div class="route-stop-item">
            <div class="route-stop-num">${i+1}</div>
            <div class="route-stop-info">
                <div class="route-stop-company">${s.company}</div>
                <div class="route-stop-address">${s.address}</div>
            </div>
        </div>`).join('');

    const html = `
        <div class="modal-overlay active" id="routeModal" onclick="closeModalOnOverlay(event,'routeModal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-handle"></div>
                    <div class="modal-title-row">
                        <button class="back-button" onclick="closeModal('routeModal')">â€¹</button>
                        <h2 class="modal-title">ğŸ—ºï¸ ìµœì  ë£¨íŠ¸</h2>
                        <button class="close-button" onclick="closeModal('routeModal')">Ã—</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="origin-input-section">
                        <label class="form-label">ğŸ“ ì¶œë°œì§€</label>
                        <input type="text" class="form-input" id="routeOriginInput" placeholder="ì¶œë°œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="margin-bottom:8px;">
                        <div class="saved-origins">
                            ${savedOriginsHTML}
                            <div class="origin-tag" onclick="saveCurrentOrigin()" style="color:var(--inbody-red);border-color:var(--inbody-red);">+ ì €ì¥</div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ“‹</span> ë°©ë¬¸ ëª©ì ì§€ (${daySchedules.length}ê³³)</div>
                        ${stopsHTML || '<div style="color:var(--text-tertiary);font-size:13px;text-align:center;padding:8px;">ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                    </div>
                    <div class="route-map-placeholder" id="routeMapArea">
                        <div style="font-size:40px;">ğŸ—ºï¸</div>
                        <div style="font-size:14px;font-weight:700;color:#2E7D32;">ìµœì  ë£¨íŠ¸ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”</div>
                        <div style="font-size:12px;color:#558B2F;">ì¶œë°œì§€ ì…ë ¥ í›„ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</div>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="closeModal('routeModal')">ë‹«ê¸°</button>
                        <button class="btn-primary" onclick="calcRoute()">ğŸ§­ ìµœì  ë£¨íŠ¸ ê²€ìƒ‰</button>
                    </div>
                </div>
            </div>
        </div>`;
    document.getElementById('modalContainer').innerHTML = html;
}

function selectOriginTag(el, value) {
    document.querySelectorAll('.origin-tag').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('routeOriginInput').value = value;
}

function saveCurrentOrigin() {
    const val = document.getElementById('routeOriginInput').value.trim();
    if (!val) { alert('ì¶œë°œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    if (!savedOrigins.includes(val)) {
        savedOrigins.push(val);
        alert(`âœ… "${val}" ì¶œë°œì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        showRouteModal();
    } else {
        alert('ì´ë¯¸ ì €ì¥ëœ ì¶œë°œì§€ì…ë‹ˆë‹¤.');
    }
}

function calcRoute() {
    const origin = document.getElementById('routeOriginInput').value.trim();
    if (!origin) { alert('ì¶œë°œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    const dateStr = formatDate(selectedDate);
    let daySchedules = schedules.filter(s => s.visitPlannedAt === dateStr);
    if (currentScheduleFilter !== 'all') daySchedules = daySchedules.filter(s => s.visitor === currentScheduleFilter);
    if (daySchedules.length === 0) { alert('ëª©ì ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    
    // ë„¤ì´ë²„ì§€ë„/ì¹´ì¹´ì˜¤ë§µ ì—°ê²°
    const addresses = [origin, ...daySchedules.map(s => s.address)];
    const waypointStr = addresses.slice(1, -1).map(a => encodeURIComponent(a)).join('|');
    const destStr = encodeURIComponent(addresses[addresses.length - 1]);
    const originStr = encodeURIComponent(addresses[0]);
    const url = `https://map.naver.com/v5/directions/-/-/-/car?departure=${originStr}&destination=${destStr}`;
    
    const mapArea = document.getElementById('routeMapArea');
    mapArea.innerHTML = `
        <div style="font-size:32px;">âœ…</div>
        <div style="font-size:14px;font-weight:700;color:#2E7D32;">ë£¨íŠ¸ ê³„ì‚° ì™„ë£Œ</div>
        <div style="font-size:12px;color:#558B2F;margin-bottom:8px;">ì¶œë°œ: ${origin}</div>
        <div style="font-size:12px;color:#558B2F;">ì´ ${daySchedules.length}ê°œ ê²½ìœ ì§€</div>
        <button class="btn-primary" style="margin-top:12px;flex:none;padding:10px 24px;" onclick="window.open('${url}','_blank')">ğŸ—ºï¸ ë„¤ì´ë²„ì§€ë„ì—ì„œ ì—´ê¸°</button>
    `;
}

// ===== DETAIL MODAL =====
function showDetail(docNo) {
    const schedule = schedules.find(s => s.docNo === docNo);
    if (!schedule) return;
    currentSchedule = schedule;
    const deliveryDate = new Date(schedule.deliveryDate);
    const receivedDate = new Date(schedule.receivedAt);
    const usageDays = Math.floor((receivedDate - deliveryDate) / (1000 * 60 * 60 * 24));
    const warranty = usageDays <= 365 ? 'ë¬´ìƒ' : 'ìœ ìƒ';
    const warrantyClass = usageDays <= 365 ? 'warranty-free' : 'warranty-paid';
    const statusClass = schedule.status === 'ëŒ€ê¸°' ? 'status-waiting' : schedule.status === 'ì§„í–‰ì¤‘' ? 'status-progress' : 'status-complete';
    const html = `
        <div class="modal-overlay active" id="detailModal" onclick="closeModalOnOverlay(event,'detailModal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-handle"></div>
                    <div class="modal-title-row">
                        <button class="back-button" onclick="closeModal('detailModal')">â€¹</button>
                        <h2 class="modal-title">ìƒì„¸ ì •ë³´</h2>
                        <button class="close-button" onclick="closeModal('detailModal')">Ã—</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ¢</span> ê³ ê° ì •ë³´</div>
                        <div class="detail-row"><span class="detail-label">ìƒí˜¸ëª…</span><span class="detail-value">${schedule.company}</span></div>
                        <div class="detail-row"><span class="detail-label">ì£¼ì†Œ</span><span class="detail-value">${schedule.address}</span></div>
                        <div class="detail-row"><span class="detail-label">ì „í™”ë²ˆí˜¸</span><span class="detail-value">${schedule.phone}</span></div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ“…</span> ë°©ë¬¸ ì •ë³´</div>
                        <div class="detail-row"><span class="detail-label">ì ‘ìˆ˜ì¼</span><span class="detail-value">${schedule.receivedAt}</span></div>
                        <div class="detail-row"><span class="detail-label">ë°©ë¬¸ì˜ˆì •ì¼</span><span class="detail-value">${schedule.visitPlannedAt}</span></div>
                        <div class="detail-row"><span class="detail-label">ë‹´ë‹¹ì§€ì‚¬</span><span class="detail-value">${schedule.branch}</span></div>
                        <div class="detail-row"><span class="detail-label">ë‹´ë‹¹ì</span><span class="detail-value">${schedule.visitor}</span></div>
                        <div class="detail-row"><span class="detail-label">ì²˜ë¦¬ë°©ë²•</span><span class="detail-value">${schedule.method}</span></div>
                        <div class="detail-row"><span class="detail-label">ìƒíƒœ</span><span class="detail-value"><span class="status-badge ${statusClass}">${schedule.status}</span></span></div>
                        <!-- ë°©ë¬¸ì˜ˆì •ì‹œê°„ ìˆ˜ì • + ë¬¸ì ì „ì†¡ -->
                        <div style="background:#F0F9FF;border:1.5px solid #BAE6FD;border-radius:10px;padding:12px;margin-top:12px;">
                            <div style="font-size:12px;font-weight:700;color:#0369A1;margin-bottom:8px;">ğŸ“± ë°©ë¬¸ì˜ˆì •ì‹œê°„ ì•ˆë‚´ ë¬¸ì</div>
                            <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
                                <label style="font-size:13px;color:#374151;white-space:nowrap;font-weight:600;">ë°©ë¬¸ì˜ˆì •ì‹œê°„</label>
                                <input type="time" id="visitTimeEdit" value="${schedule.visitRequestTime}" style="flex:1;padding:8px 10px;border:1.5px solid #BAE6FD;border-radius:8px;font-size:15px;font-family:inherit;background:white;">
                            </div>
                            <button onclick="openSmsPreviewer('${schedule.docNo}')" style="width:100%;padding:10px;background:#0EA5E9;color:white;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;">
                                ğŸ’¬ ê³ ê° ë¬¸ì ë¯¸ë¦¬ë³´ê¸° ë° ì „ì†¡
                            </button>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="section-title-with-camera">
                                <span class="section-icon">âš™ï¸</span> ì¥ë¹„ ì •ë³´
                                <button class="camera-btn-inline" onclick="scanEquipmentBarcode()" title="ë°”ì½”ë“œ ìŠ¤ìº”">ğŸ“·</button>
                            </div>
                        </div>
                        <div class="detail-row"><span class="detail-label">ë¬¸ì„œë²ˆí˜¸</span><span class="detail-value">${schedule.docNo}</span></div>
                        <div class="detail-row"><span class="detail-label">ì œí’ˆëª…</span><span class="detail-value">${schedule.product}</span></div>
                        <div class="detail-row"><span class="detail-label">ë²„ì „</span><span class="detail-value">${schedule.version}</span></div>
                        <div class="detail-row"><span class="detail-label">S/N</span><span class="detail-value">${schedule.serial}</span></div>
                        <div class="detail-row"><span class="detail-label">ìƒì‚°ì¼</span><span class="detail-value">${schedule.mfgDate}</span></div>
                        <div class="detail-row"><span class="detail-label">ë‚©í’ˆì¼</span><span class="detail-value">${schedule.deliveryDate}</span></div>
                        <div class="detail-row"><span class="detail-label">ì‚¬ìš©ì¼</span><span class="detail-value">${usageDays}ì¼</span></div>
                        <div class="detail-row"><span class="detail-label">ìœ ë¬´ìƒ</span><span class="detail-value"><span class="warranty-badge ${warrantyClass}">${warranty}</span></span></div>
                    </div>
                    <div class="detail-section fault-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ”§</span> ë¶ˆëŸ‰ ì •ë³´</div>
                        <div class="detail-row"><span class="detail-label">ë¶ˆëŸ‰êµ¬ë¶„ ëŒ€ë¶„ë¥˜</span><span class="detail-value">${schedule.faultMajor}</span></div>
                        <div class="detail-row"><span class="detail-label">ë¶ˆëŸ‰êµ¬ë¶„ ì†Œë¶„ë¥˜</span><span class="detail-value">${schedule.faultMinor}</span></div>
                        <div class="detail-full"><div class="detail-full-label">ì ‘ìˆ˜ë‚´ìš©</div><div class="detail-full-value">${schedule.receiptContent}</div></div>
                        ${schedule.prevAction ? `<div class="detail-full"><div class="detail-full-label">ì´ì „ ì²˜ë¦¬ë‚´ìš©</div><div class="detail-full-value">${schedule.prevAction}</div></div>` : ''}
                    </div>
                    <div class="action-buttons">
                        <button class="action-button" onclick="openMap()"><div class="action-icon">ğŸ“</div><div>ìœ„ì¹˜</div></button>
                        <button class="action-button" onclick="callCustomer()"><div class="action-icon">ğŸ“</div><div>ì „í™”</div></button>
                        <button class="action-button" onclick="showServiceReport()"><div class="action-icon">âœï¸</div><div>ì„œë¹„ìŠ¤ ë¦¬í¬íŠ¸</div></button>
                    </div>
                </div>
            </div>
        </div>`;
    document.getElementById('modalContainer').innerHTML = html;
}

function openMap() {
    if (!currentSchedule) return;
    window.open(`https://map.naver.com/v5/search/${encodeURIComponent(currentSchedule.address)}`, '_blank');
}
function callCustomer() { if (!currentSchedule) return; window.location.href = `tel:${currentSchedule.phone}`; }

// ===== SMS PREVIEWER =====
function openSmsPreviewer(docNo) {
    const schedule = schedules.find(s => s.docNo === docNo);
    if (!schedule) return;
    const timeInput = document.getElementById('visitTimeEdit');
    const visitTime = timeInput ? timeInput.value : schedule.visitRequestTime;
    // ì‹œê°„ í¬ë§· (24h â†’ 12h í‘œì‹œ)
    const [hh, mm] = visitTime.split(':');
    const h = parseInt(hh);
    const timeStr = `${h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„'} ${h <= 12 ? h : h - 12}ì‹œ ${mm}ë¶„`;
    const smsText = `ì•ˆë…•í•˜ì„¸ìš”, ${schedule.company} ë‹´ë‹¹ìë‹˜.\nInBody AS ë‹´ë‹¹ ${schedule.visitor}ì…ë‹ˆë‹¤.\n\në°©ë¬¸ ì˜ˆì • ì¼ì •ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\nğŸ“… ë°©ë¬¸ì¼: ${schedule.visitPlannedAt}\nâ° ë°©ë¬¸ì˜ˆì •ì‹œê°„: ${timeStr}\n\në°©ë¬¸ ì „ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\nê°ì‚¬í•©ë‹ˆë‹¤.`;
    
    const popup = `
        <div class="modal-overlay active" id="smsPopupModal" onclick="if(event.target.id==='smsPopupModal')closeModal('smsPopupModal')" style="z-index:1100;">
            <div class="modal-content" onclick="event.stopPropagation()" style="max-height:80vh;">
                <div class="modal-header">
                    <div class="modal-handle"></div>
                    <div class="modal-title-row">
                        <button class="back-button" onclick="closeModal('smsPopupModal')">â€¹</button>
                        <h2 class="modal-title">ë¬¸ì ë¯¸ë¦¬ë³´ê¸°</h2>
                        <button class="close-button" onclick="closeModal('smsPopupModal')">Ã—</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div style="background:#F0F9FF;border:1.5px solid #BAE6FD;border-radius:10px;padding:14px;margin-bottom:16px;">
                        <div style="font-size:11px;color:#0369A1;font-weight:700;margin-bottom:8px;">ìˆ˜ì‹ ë²ˆí˜¸: ${schedule.phone}</div>
                        <div style="background:white;border-radius:8px;padding:14px;font-size:14px;line-height:1.8;color:#1E293B;white-space:pre-wrap;border:1px solid #E0F2FE;">${smsText}</div>
                    </div>
                    <div style="background:#FEF9C3;border:1px solid #FDE047;border-radius:8px;padding:10px;font-size:12px;color:#713F12;margin-bottom:16px;">
                        âš ï¸ ì „ì†¡ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê³ ê° ì „í™”ë²ˆí˜¸(${schedule.phone})ë¡œ ë¬¸ìê°€ ì „ì†¡ë©ë‹ˆë‹¤.
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="closeModal('smsPopupModal')">ì·¨ì†Œ</button>
                        <button class="btn-primary" onclick="sendSmsToCustomer('${schedule.phone}', \`${smsText.replace(/`/g, '\\`')}\`)">ğŸ“± ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>`;
    // SMS íŒì—…ì„ ë³„ë„ divì— í‘œì‹œ (ê¸°ì¡´ ëª¨ë‹¬ ìœ„ì—)
    let smsContainer = document.getElementById('smsModalContainer');
    if (!smsContainer) {
        smsContainer = document.createElement('div');
        smsContainer.id = 'smsModalContainer';
        document.body.appendChild(smsContainer);
    }
    smsContainer.innerHTML = popup;
    // ë°©ë¬¸ì˜ˆì •ì‹œê°„ ì—…ë°ì´íŠ¸
    if (schedule && timeInput) {
        schedule.visitRequestTime = visitTime;
    }
}

function sendSmsToCustomer(phone, text) {
    // SMS ì „ì†¡: sms: URI í”„ë¡œí† ì½œ ì‚¬ìš© (ì‹¤ì œ ê¸°ê¸°ì—ì„œ ë¬¸ìì•± ì—´ë¦¼)
    const encoded = encodeURIComponent(text);
    const smsUri = `sms:${phone}?body=${encoded}`;
    window.location.href = smsUri;
    const smsContainer = document.getElementById('smsModalContainer');
    if (smsContainer) smsContainer.innerHTML = '';
    // ì „ì†¡ ì™„ë£Œ í† ìŠ¤íŠ¸
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#059669;color:white;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:700;z-index:2000;';
    toast.textContent = 'âœ… ë¬¸ì ì•±ì´ ì—´ë ¸ìŠµë‹ˆë‹¤';
    document.body.appendChild(toast);
    setTimeout(() => document.body.removeChild(toast), 3000);
}

// ===== PEER CASE (ë‹¤ë¥¸ ê¸°ì‚¬ ì²˜ë¦¬ ì‚¬ë¡€) =====
function buildPeerCaseHTML(faultMinor) {
    const cases = peerCaseDB[faultMinor];
    if (!cases || cases.length === 0) {
        return `<div style="text-align:center;color:var(--text-tertiary);font-size:13px;padding:12px;font-style:italic;">í•´ë‹¹ ë¶ˆëŸ‰ì— ëŒ€í•œ ì²˜ë¦¬ ì‚¬ë¡€ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
    }
    return cases.map((c, i) => `
        <div style="background:white;border-radius:8px;padding:12px;margin-bottom:8px;border-left:3px solid #4ADE80;box-shadow:0 1px 4px rgba(0,0,0,0.07);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="width:26px;height:26px;border-radius:50%;background:#16A34A;color:white;font-size:11px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;">${i+1}</span>
                    <span style="font-size:13px;font-weight:700;color:#166534;">${c.tech}</span>
                    <span style="font-size:11px;color:var(--text-tertiary);">${c.product}</span>
                </div>
                <span style="font-size:11px;color:var(--text-tertiary);">${c.date}</span>
            </div>
            <div style="font-size:13px;color:#374151;line-height:1.6;margin-bottom:6px;">${c.result}</div>
            <div style="display:flex;flex-wrap:wrap;gap:4px;">${c.tags.map(t=>`<span style="background:#DCFCE7;color:#166534;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">#${t}</span>`).join('')}</div>
        </div>`).join('');
}

function togglePeerCase() {
    const body = document.getElementById('peerCaseBody');
    const icon = document.getElementById('peerCaseToggleIcon');
    if (!body) return;
    const isOpen = body.style.display !== 'none';
    body.style.display = isOpen ? 'none' : 'block';
    if (icon) icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
}

// ===== ì‚¬ì—…ìë“±ë¡ì¦ ì—…ë¡œë“œ =====
let bizRegPhoto = null;
function handleBizRegUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        bizRegPhoto = e.target.result;
        const preview = document.getElementById('bizRegPhotoPreview');
        if (preview) {
            preview.innerHTML = `
                <div style="position:relative;display:inline-block;width:100%;">
                    <img src="${bizRegPhoto}" style="width:100%;border-radius:8px;max-height:200px;object-fit:contain;border:1px solid #FED7AA;">
                    <button onclick="removeBizRegPhoto()" style="position:absolute;top:6px;right:6px;width:26px;height:26px;border-radius:50%;border:none;background:rgba(0,0,0,0.6);color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;">Ã—</button>
                </div>`;
        }
    };
    reader.readAsDataURL(file);
}
function removeBizRegPhoto() {
    bizRegPhoto = null;
    const preview = document.getElementById('bizRegPhotoPreview');
    if (preview) preview.innerHTML = '';
    const input = document.getElementById('bizRegInput');
    if (input) input.value = '';
}


// ===== BARCODE SCAN =====
function scanEquipmentBarcode() {
    document.getElementById('equipmentBarcodeInput').click();
}
function handleEquipmentBarcode(event) {
    // Demo: simulate barcode scan
    alert('ğŸ“· ì¥ë¹„ ë°”ì½”ë“œ ìŠ¤ìº”\n\nì‹¤ì œ ê¸°ê¸°ì—ì„œëŠ” ì¹´ë©”ë¼ë¡œ ë°”ì½”ë“œë¥¼ ì¸ì‹í•©ë‹ˆë‹¤.\n\n[ë°ëª¨] InBody 770 ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤:\nì œí’ˆëª…: InBody 770\nS/N: SN-770-2026-DEMO\nìƒì‚°ì¼: 2024-08-01');
    if (currentSchedule) {
        currentSchedule.product = 'InBody 770';
        currentSchedule.serial = 'SN-770-2026-DEMO';
        currentSchedule.mfgDate = '2024-08-01';
    }
}

// ===== SERVICE REPORT MODAL =====
function showServiceReport() {
    if (!currentSchedule) return;
    materials = [];
    isRevisitScheduled = false;
    currentCheckedItems = [];
    
    const majorOptions = Object.keys(defectDB).map(major =>
        `<option value="${major}" ${currentSchedule.faultMajor===major?'selected':''}>${major}</option>`).join('');
    const minorOptions = (defectDB[currentSchedule.faultMajor]||[]).map(minor =>
        `<option value="${minor}" ${currentSchedule.faultMinor===minor?'selected':''}>${minor}</option>`).join('');
    const resultMajorOptions = Object.keys(serviceResultDB).map(major =>
        `<option value="${major}">${major}</option>`).join('');

    // ì²˜ë¦¬ë°©ë²• ê°€ì´ë“œ
    const guideData = guideDB[currentSchedule.faultMinor];
    const guideHTML = guideData ? buildGuideHTML(guideData) : `<div style="color:var(--text-tertiary);font-size:13px;text-align:center;padding:8px 0;font-style:italic;">í•´ë‹¹ ë¶ˆëŸ‰ì— ëŒ€í•œ ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>`;

    // ì²´í¬ë¦¬ìŠ¤íŠ¸
    const checkItems = checklistDB[currentSchedule.faultMinor] || [];
    const checklistHTML = buildChecklistHTML(checkItems);

    const html = `
        <div class="modal-overlay active" id="reportModal" onclick="closeModalOnOverlay(event,'reportModal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-handle"></div>
                    <div class="modal-title-row">
                        <button class="back-button" onclick="closeModal('reportModal'); showDetail('${currentSchedule.docNo}')">â€¹</button>
                        <h2 class="modal-title">ì„œë¹„ìŠ¤ ë¦¬í¬íŠ¸</h2>
                        <button class="close-button" onclick="closeModal('reportModal')">Ã—</button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- AI ì–´ì‹œìŠ¤í„´íŠ¸ -->
                    <div class="ai-section">
                        <div class="ai-section-header">
                            <span class="ai-badge">AI</span>
                            <span class="ai-section-title">ì–´ë–¤ ë¬¸ì œê°€ ë°œìƒí–ˆë‚˜ìš”?</span>
                        </div>
                        <div class="ai-body">
                            <div class="ai-input-row">
                                <input type="text" class="ai-input" id="aiQuery" placeholder="ì¦ìƒì„ ì…ë ¥í•˜ë©´ AIê°€ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤..." onkeydown="if(event.key==='Enter') sendAiQuery()">
                                <button class="ai-send-btn" onclick="sendAiQuery()">â¤</button>
                            </div>
                            <div class="ai-response-area" id="aiResponseArea"></div>
                        </div>
                    </div>

                    <!-- ë°©ë¬¸ ì •ë³´ -->
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ“…</span> ë°©ë¬¸ ì •ë³´</div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label">ë°©ë¬¸ì¼</label>
                            <input type="date" class="form-input" id="serviceDate" value="${formatDate(new Date())}">
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label">ì²˜ë¦¬ì¼</label>
                            <div style="display:flex;gap:12px;align-items:center;">
                                <input type="date" class="form-input" id="serviceCompleteDate" value="${formatDate(new Date())}" style="flex:1;">
                                <label style="display:flex;align-items:center;gap:6px;white-space:nowrap;cursor:pointer;">
                                    <input type="checkbox" id="revisitCheckbox" onchange="toggleRevisit()" style="width:18px;height:18px;cursor:pointer;">
                                    <span style="font-size:14px;font-weight:600;">ì¬ë°©ë¬¸ì˜ˆì •</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label class="form-label">ë‹´ë‹¹ì</label>
                            <input type="text" class="form-input" id="serviceWorker" value="${currentSchedule.visitor}" readonly>
                        </div>
                    </div>

                    <!-- ì¥ë¹„ ì •ë³´ (í¸ì§‘ ê°€ëŠ¥ + ì¹´ë©”ë¼) -->
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="section-title-with-camera">
                                <span class="section-icon">âš™ï¸</span> ì¥ë¹„ ì •ë³´
                                <button class="camera-btn-inline" onclick="scanEquipmentBarcode()" title="ë°”ì½”ë“œë¡œ ì¥ë¹„ì •ë³´ ìë™ì…ë ¥">ğŸ“·</button>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom:12px;">
                            <label class="form-label">ì œí’ˆëª…</label>
                            <input type="text" class="form-input" id="rptProduct" value="${currentSchedule.product}">
                        </div>
                        <div class="form-group" style="margin-bottom:12px;">
                            <label class="form-label">S/N</label>
                            <input type="text" class="form-input" id="rptSerial" value="${currentSchedule.serial}">
                        </div>
                        <div class="form-group" style="margin-bottom:12px;">
                            <label class="form-label">ìƒì‚°ì¼</label>
                            <input type="text" class="form-input" id="rptMfgDate" value="${currentSchedule.mfgDate}">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label class="form-label" style="display:flex;align-items:center;gap:8px;">
                                ë²„ì „
                                <button class="camera-btn-inline" onclick="scanQRCode()" title="QCì½”ë“œë¡œ ë²„ì „ì •ë³´ ìë™ì…ë ¥" style="font-size:12px;width:24px;height:24px;">QC</button>
                            </label>
                            <div class="version-input-row">
                                <input type="text" class="form-input" id="rptVersion" value="${currentSchedule.version}" placeholder="v3.2.1">
                            </div>
                            <div id="qrInfoArea" style="display:none;margin-top:8px;padding:10px;background:#EDE7F6;border-radius:8px;font-size:12px;color:#4527A0;"></div>
                        </div>
                    </div>

                    <!-- ë¶ˆëŸ‰ ì •ë³´ -->
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ”</span> ë¶ˆëŸ‰ ì •ë³´</div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label">ë¶ˆëŸ‰êµ¬ë¶„ ëŒ€ë¶„ë¥˜</label>
                            <select class="form-select" id="faultMajor" onchange="updateFaultMinorOptions()">
                                ${majorOptions}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label class="form-label">ë¶ˆëŸ‰êµ¬ë¶„ ì†Œë¶„ë¥˜</label>
                            <select class="form-select" id="faultMinor" onchange="onFaultMinorChange()">
                                ${minorOptions}
                            </select>
                        </div>
                    </div>

                    <!-- ì²˜ë¦¬ë°©ë²• ê°€ì´ë“œ -->
                    <div class="guide-section" id="guideSection">
                        <div class="guide-section-header" onclick="toggleGuide()">
                            <div class="guide-title-badge">
                                <span class="guide-badge">GUIDE</span>
                                <span class="guide-title-text">ì²˜ë¦¬ë°©ë²• ê°€ì´ë“œ</span>
                            </div>
                            <span class="guide-toggle-icon" id="guideToggleIcon">â–¼</span>
                        </div>
                        <div class="guide-body" id="guideBody">
                            ${guideHTML}
                        </div>
                    </div>

                    <!-- ë‹¤ë¥¸ ASê¸°ì‚¬ ì²˜ë¦¬ ì‚¬ë¡€ -->
                    <div id="peerCaseSection" style="background:linear-gradient(135deg,#F0FDF4,#ECFDF5);border:2px solid #4ADE80;border-radius:var(--radius-md);margin-bottom:var(--spacing-md);overflow:hidden;">
                        <div onclick="togglePeerCase()" style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#16A34A;cursor:pointer;">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <span style="background:rgba(255,255,255,0.25);color:white;padding:2px 8px;border-radius:12px;font-size:10px;font-weight:700;letter-spacing:0.5px;">CASES</span>
                                <span style="font-size:14px;font-weight:700;color:white;">ë‹¤ë¥¸ ì§ì› ì²˜ë¦¬ ì‚¬ë¡€ ì°¸ê³ </span>
                            </div>
                            <span id="peerCaseToggleIcon" style="font-size:16px;color:white;transition:transform 0.2s;">â–¼</span>
                        </div>
                        <div id="peerCaseBody" style="padding:12px;display:none;">
                            ${buildPeerCaseHTML(currentSchedule.faultMinor)}
                        </div>
                    </div>

                    <!-- ì²˜ë¦¬ ê²°ê³¼ -->
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">âœ…</span> ì²˜ë¦¬ ê²°ê³¼</div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label">ì²˜ë¦¬ê²°ê³¼ ëŒ€ë¶„ë¥˜</label>
                            <select class="form-select" id="resultMajor" onchange="updateResultMinorOptions()">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                ${resultMajorOptions}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label">ì²˜ë¦¬ê²°ê³¼ ì†Œë¶„ë¥˜</label>
                            <select class="form-select" id="resultMinor">
                                <option value="">ëŒ€ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                        <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
                        <div class="checklist-section" id="checklistSection">
                            <div class="checklist-header">
                                <span class="checklist-title">âœ” ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
                            </div>
                            <div class="checklist-body" id="checklistBody">
                                ${checklistHTML}
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom:0;margin-top:16px;">
                            <label class="form-label">ì²˜ë¦¬ë‚´ì—­</label>
                            <textarea class="form-textarea" id="serviceDetail" placeholder="í˜„ì¥ì—ì„œ ìˆ˜í–‰í•œ ì‘ì—… ë‚´ìš©ì„ ìƒì„¸íˆ ê¸°ë¡í•´ì£¼ì„¸ìš”."></textarea>
                        </div>
                    </div>

                    <!-- ìì¬ ë° ë¹„ìš© -->
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ’°</span> ìì¬ ë° ë¹„ìš©</div>
                        <!-- ê³ ê°ì •ë³´ ì¶”ê°€: ì‚¬ì—…ìë“±ë¡ì¦ -->
                        <div style="background:#FFF7ED;border:1.5px solid #FED7AA;border-radius:10px;padding:12px;margin-bottom:16px;">
                            <div style="font-size:12px;font-weight:700;color:#C2410C;margin-bottom:10px;">ğŸ¢ ê³ ê°ì •ë³´ ì¶”ê°€ (ì‚¬ì—…ìë“±ë¡ì¦)</div>
                            <div id="bizRegPhotoPreview" style="margin-bottom:8px;"></div>
                            <button onclick="document.getElementById('bizRegInput').click()" style="width:100%;padding:10px;background:white;border:1.5px dashed #FB923C;border-radius:8px;color:#C2410C;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px;">
                                ğŸ“· ì‚¬ì—…ìë“±ë¡ì¦ ì´¬ì˜/ì—…ë¡œë“œ
                            </button>
                            <input type="file" id="bizRegInput" accept="image/*" capture="camera" style="display:none;" onchange="handleBizRegUpload(event)">
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label">ì‚¬ìš© ìì¬</label>
                            <div id="materialsContainer"></div>
                            <button class="add-material-btn" onclick="addMaterial()">+ ìì¬ ì¶”ê°€</button>
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label">ì¶œì¥ë¹„ (ì›)</label>
                            <input type="number" class="form-input" id="travelCost" value="33000" onchange="calculateTotal()">
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label">ê²°ì œë°©ë²•</label>
                            <select class="form-select" id="paymentMethod">
                                <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                                <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                                <option value="ì…ê¸ˆ">ì…ê¸ˆ</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label class="form-label">ì´ ê¸ˆì•¡ (VAT í¬í•¨)</label>
                            <input type="number" class="form-input" id="totalAmount" value="33000" readonly>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="closeModal('reportModal'); showDetail('${currentSchedule.docNo}')">â† ë’¤ë¡œ</button>
                        <button class="btn-primary" onclick="submitServiceReport()">ì €ì¥</button>
                    </div>

                    <!-- ìœ ìƒë¬´ìƒ ë³´ê³ ìš© -->
                    <div style="margin-top:16px;">
                        <button class="btn-primary" style="width:100%;background:#4A148C;" onclick="showWarrantyReport()">ğŸ“‹ ìœ ìƒë¬´ìƒ ë³´ê³ ìš©</button>
                    </div>
                </div>
            </div>
        </div>`;
    closeModal('detailModal');
    document.getElementById('modalContainer').innerHTML = html;
}

// ===== GUIDE =====
function buildGuideHTML(guideData) {
    return guideData.items.map((item, i) => `
        <div class="guide-item">
            <div class="guide-item-header">
                <div class="guide-item-num">${i+1}</div>
                <div class="guide-item-title">${item.title}</div>
            </div>
            <div class="guide-item-content">
                ${item.content.replace(/\n/g,'<br>')}
                ${item.media ? `
                    <div class="guide-media-placeholder" onclick="alert('${item.isVideo ? 'ğŸ“¹ ì˜ìƒì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.' : 'ğŸ–¼ï¸ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.'}')">
                        ${item.isVideo ? 'â–¶ ì˜ìƒ ë³´ê¸°' : 'ğŸ–¼ï¸ ì´ë¯¸ì§€ ë³´ê¸°'}
                    </div>` : ''}
                ${item.tags ? `<div class="guide-tag-list">${item.tags.map(t=>`<div class="guide-tag">${t}</div>`).join('')}</div>` : ''}
            </div>
        </div>`).join('');
}

function toggleGuide() {
    const body = document.getElementById('guideBody');
    const icon = document.getElementById('guideToggleIcon');
    body.classList.toggle('open');
    icon.classList.toggle('open');
}

function onFaultMinorChange() {
    const minor = document.getElementById('faultMinor').value;
    // Update guide
    const guideData = guideDB[minor];
    const guideBody = document.getElementById('guideBody');
    if (guideBody) {
        guideBody.innerHTML = guideData ? buildGuideHTML(guideData) : `<div style="color:var(--text-tertiary);font-size:13px;text-align:center;padding:8px 0;font-style:italic;">í•´ë‹¹ ë¶ˆëŸ‰ì— ëŒ€í•œ ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
    }
    // Update peer cases
    const peerCaseBody = document.getElementById('peerCaseBody');
    if (peerCaseBody) {
        peerCaseBody.innerHTML = buildPeerCaseHTML(minor);
    }
    // Update checklist
    const checkItems = checklistDB[minor] || [];
    const checklistBody = document.getElementById('checklistBody');
    if (checklistBody) {
        currentCheckedItems = [];
        checklistBody.innerHTML = buildChecklistHTML(checkItems);
    }
}

// ===== CHECKLIST =====
function buildChecklistHTML(items) {
    if (!items || items.length === 0) return `<div class="checklist-empty">ì„ íƒëœ ë¶ˆëŸ‰ ìœ í˜•ì— ëŒ€í•œ ì²´í¬í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
    return items.map((item,i) => `
        <div class="check-item" id="check-${i}" onclick="toggleCheckItem(${i},'${item.replace(/'/g,"\\'")}')">
            <div class="check-item-box" id="checkBox-${i}"></div>
            <div class="check-item-label">${item}</div>
        </div>`).join('') + `<div class="checklist-hint">ì²´í¬í•œ í•­ëª©ì´ ì²˜ë¦¬ë‚´ì—­ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤</div>`;
}

function toggleCheckItem(idx, label) {
    const item = document.getElementById(`check-${idx}`);
    const box = document.getElementById(`checkBox-${idx}`);
    const isChecked = item.classList.contains('checked');
    if (isChecked) {
        item.classList.remove('checked');
        box.innerHTML = '';
        currentCheckedItems = currentCheckedItems.filter(l => l !== label);
    } else {
        item.classList.add('checked');
        box.innerHTML = 'âœ“';
        if (!currentCheckedItems.includes(label)) currentCheckedItems.push(label);
    }
    // Update serviceDetail textarea
    const ta = document.getElementById('serviceDetail');
    if (ta) {
        const manualText = ta.value.replace(/\[ì²´í¬ë¦¬ìŠ¤íŠ¸\][\s\S]*?\n\n/, '').replace(/\[ì²´í¬ë¦¬ìŠ¤íŠ¸\][\s\S]*$/, '');
        if (currentCheckedItems.length > 0) {
            ta.value = `[ì²´í¬ë¦¬ìŠ¤íŠ¸]\n${currentCheckedItems.map(l=>`âœ” ${l}`).join('\n')}\n\n${manualText}`;
        } else {
            ta.value = manualText;
        }
    }
}

// ===== AI =====
function sendAiQuery() {
    const query = document.getElementById('aiQuery').value.trim();
    if (!query) return;
    const area = document.getElementById('aiResponseArea');
    area.classList.add('visible');
    area.innerHTML = `<div class="ai-thinking">AI ë¶„ì„ ì¤‘ <div class="ai-dot-anim"><span></span><span></span><span></span></div></div>`;
    
    setTimeout(() => {
        // Demo AI response based on fault minor
        const minor = document.getElementById('faultMinor') ? document.getElementById('faultMinor').value : currentSchedule.faultMinor;
        let response = '';
        if (query.includes('ë°°í„°ë¦¬') || minor.includes('ë°°í„°ë¦¬')) {
            response = `ğŸ“Š <strong>AI ë¶„ì„ ê²°ê³¼</strong><br><br>ì¦ìƒ: <em>${query}</em><br><br>ìœ ì‚¬ ì¼€ì´ìŠ¤ 23ê±´ ë¶„ì„ ê²°ê³¼:<br>â€¢ ë°°í„°ë¦¬ ì…€ ë¶ˆëŸ‰ (52%) â€” êµì²´ ê¶Œì¥<br>â€¢ ì¶©ì „ íšŒë¡œ ì´ìƒ (31%) â€” ì „ì›ë¶€ ì ê²€<br>â€¢ íŒì›¨ì–´ ì˜¤ë¥˜ (17%) â€” ì—…ë°ì´íŠ¸ í›„ ì¬í™•ì¸<br><br>ğŸ’¡ ìš°ì„  ì¶”ì²œ: ë°°í„°ë¦¬ íŒ© êµì²´ (BATT-INB-770-V2)`;
        } else if (query.includes('ì²´ì¤‘') || minor.includes('ì²´ì¤‘')) {
            response = `ğŸ“Š <strong>AI ë¶„ì„ ê²°ê³¼</strong><br><br>ì¦ìƒ: <em>${query}</em><br><br>ìœ ì‚¬ ì¼€ì´ìŠ¤ 18ê±´ ë¶„ì„ ê²°ê³¼:<br>â€¢ ë¡œë“œì…€ ë¶ˆëŸ‰ (44%) â€” êµì²´ ê¶Œì¥<br>â€¢ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì˜¤ë¥˜ (38%) â€” ì˜ì  ì¬ì¡°ì •<br>â€¢ ë°œíŒ ìˆ˜í‰ ë¬¸ì œ (18%) â€” í™˜ê²½ í™•ì¸<br><br>ğŸ’¡ ìš°ì„  ì¶”ì²œ: ì˜ì  ìº˜ë¦¬ë¸Œë ˆì´ì…˜ 3íšŒ ìˆ˜í–‰`;
        } else {
            response = `ğŸ“Š <strong>AI ë¶„ì„ ê²°ê³¼</strong><br><br>ì¦ìƒ: <em>${query}</em><br><br>í•´ë‹¹ ì¦ìƒì˜ ìœ ì‚¬ ì¼€ì´ìŠ¤ ë¶„ì„:<br>â€¢ í•˜ë“œì›¨ì–´ ë¶ˆëŸ‰ (45%)<br>â€¢ ì†Œí”„íŠ¸ì›¨ì–´ ì˜¤ë¥˜ (35%)<br>â€¢ í™˜ê²½ì  ìš”ì¸ (20%)<br><br>ğŸ’¡ ë³´ë‹¤ ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ ì¦ìƒì„ êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.`;
        }
        area.innerHTML = response;
    }, 1800);
}

// ===== QR SCAN (VERSION) =====
function scanQRCode() {
    document.getElementById('qrInput').click();
}
function handleQRScan(event) {
    // Demo
    const qrData = {
        version: 'v3.3.1',
        measurements: '1,247',
        calibration: '2025-12-10',
        eventCode: 'E-0023'
    };
    const area = document.getElementById('qrInfoArea');
    if (area) {
        area.style.display = 'block';
        area.innerHTML = `
            <strong>ğŸ“± QR ìŠ¤ìº” ê²°ê³¼</strong><br>
            Ver. ${qrData.version} / ì¸¡ì •íšŸìˆ˜ ${qrData.measurements}<br>
            Calibration: ${qrData.calibration} / EventCode: ${qrData.eventCode}
        `;
    }
    const versionInput = document.getElementById('rptVersion');
    if (versionInput) versionInput.value = qrData.version;
}

// ===== WARRANTY REPORT =====
function showWarrantyReport() {
    // Check if saved
    const docNo = currentSchedule ? currentSchedule.docNo : null;
    const saved = docNo && currentSchedule.savedReport;
    
    if (!saved) {
        alert('âš ï¸ ë¨¼ì € ì„œë¹„ìŠ¤ ë¦¬í¬íŠ¸ë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.\nì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°ì´í„°ë¥¼ ì €ì¥í•œ í›„ ë³´ê³ ì„œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    const r = currentSchedule.savedReport;
    const deliveryDate = new Date(currentSchedule.deliveryDate);
    const usedDate = new Date(r.serviceDate);
    const usageDays = Math.floor((usedDate - deliveryDate) / (1000 * 60 * 60 * 24));
    const warranty = usageDays <= 365 ? 'ë¬´ìƒ' : 'ìœ ìƒ';
    
    const html = `
        <div class="modal-overlay active" id="warrantyModal" onclick="closeModalOnOverlay(event,'warrantyModal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-handle"></div>
                    <div class="modal-title-row">
                        <button class="back-button" onclick="closeModal('warrantyModal')">â€¹</button>
                        <h2 class="modal-title">ìœ ìƒë¬´ìƒ ë³´ê³ ìš©</h2>
                        <button class="close-button" onclick="closeModal('warrantyModal')">Ã—</button>
                    </div>
                </div>
                <div class="modal-body" style="padding:0;">
                    <div class="report-header-bar">
                        <h3>ì„œë¹„ìŠ¤ ì²˜ë¦¬ ë³´ê³ ì„œ</h3>
                        <p>InBody Customer Service Report Â· ${r.serviceDate}</p>
                    </div>
                    <div style="padding:12px;">
                        <div class="report-grid">
                            <div class="report-cell"><div class="report-cell-label">ë‹´ë‹¹ì§€ì‚¬</div><div class="report-cell-value">${currentSchedule.branch}</div></div>
                            <div class="report-cell"><div class="report-cell-label">ìƒí˜¸ëª…</div><div class="report-cell-value">${currentSchedule.company}</div></div>
                            <div class="report-cell"><div class="report-cell-label">ì œí’ˆëª…</div><div class="report-cell-value">${r.product||currentSchedule.product}</div></div>
                            <div class="report-cell"><div class="report-cell-label">S/N</div><div class="report-cell-value">${r.serial||currentSchedule.serial}</div></div>
                            <div class="report-cell"><div class="report-cell-label">ìƒì‚°ì¼</div><div class="report-cell-value">${r.mfgDate||currentSchedule.mfgDate}</div></div>
                            <div class="report-cell"><div class="report-cell-label">ë‚©í’ˆì¼</div><div class="report-cell-value">${currentSchedule.deliveryDate}</div></div>
                            <div class="report-cell"><div class="report-cell-label">ì ‘ìˆ˜ì¼</div><div class="report-cell-value">${currentSchedule.receivedAt}</div></div>
                            <div class="report-cell"><div class="report-cell-label">ì²˜ë¦¬ì¼</div><div class="report-cell-value">${r.serviceCompleteDate}</div></div>
                            <div class="report-cell"><div class="report-cell-label">ì‚¬ìš©ì¼ìˆ˜</div><div class="report-cell-value">${usageDays}ì¼</div></div>
                            <div class="report-cell"><div class="report-cell-label">ìœ ë¬´ìƒ êµ¬ë¶„</div><div class="report-cell-value" style="color:${warranty==='ë¬´ìƒ'?'#059669':'#DC2626'};font-weight:700;">${warranty}</div></div>
                        </div>
                        <div class="report-cell-full">
                            <div class="report-cell-label">ì ‘ìˆ˜ë‚´ìš©</div>
                            <div class="report-cell-value" style="font-weight:400;margin-top:4px;line-height:1.6;">${currentSchedule.receiptContent}</div>
                        </div>
                        <div class="report-cell-full" style="border-bottom:none;">
                            <div class="report-cell-label">ì²˜ë¦¬ë‚´ìš©</div>
                            <div class="report-cell-value" style="font-weight:400;margin-top:4px;line-height:1.6;">${r.serviceDetail||'-'}</div>
                        </div>
                        <div class="button-group" style="padding:0 0 8px;">
                            <button class="btn-secondary" onclick="closeModal('warrantyModal')">ë‹«ê¸°</button>
                            <button class="btn-copy" onclick="copyWarrantyReport()">ğŸ“‹ ë³µì‚¬</button>
                            <button class="btn-capture" onclick="captureWarrantyReport()">ğŸ“¸ ìº¡ì³</button>
                        </div>
                        <div id="copyToast" style="display:none;text-align:center;margin-top:8px;padding:8px 12px;background:#059669;color:white;border-radius:8px;font-size:13px;font-weight:600;">âœ… í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                        <div id="captureToast" style="display:none;text-align:center;margin-top:8px;padding:8px 12px;background:#2563EB;color:white;border-radius:8px;font-size:13px;font-weight:600;">ğŸ“¸ ì´ë¯¸ì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                    </div>
                </div>
            </div>
        </div>`;
    document.getElementById('modalContainer').innerHTML = html;
}

function copyWarrantyReport() {
    if (!currentSchedule || !currentSchedule.savedReport) return;
    const r = currentSchedule.savedReport;
    const deliveryDate = new Date(currentSchedule.deliveryDate);
    const usedDate = new Date(r.serviceDate);
    const usageDays = Math.floor((usedDate - deliveryDate) / (1000 * 60 * 60 * 24));
    const warranty = usageDays <= 365 ? 'ë¬´ìƒ' : 'ìœ ìƒ';

    const text = [
        '[ ì„œë¹„ìŠ¤ ì²˜ë¦¬ ë³´ê³ ì„œ ]',
        `InBody Customer Service Report Â· ${r.serviceDate}`,
        '',
        `ë‹´ë‹¹ì§€ì‚¬     : ${currentSchedule.branch}`,
        `ìƒí˜¸ëª…       : ${currentSchedule.company}`,
        `ì œí’ˆëª…       : ${r.product || currentSchedule.product}`,
        `S/N         : ${r.serial || currentSchedule.serial}`,
        `ìƒì‚°ì¼       : ${r.mfgDate || currentSchedule.mfgDate}`,
        `ë‚©í’ˆì¼       : ${currentSchedule.deliveryDate}`,
        `ì ‘ìˆ˜ì¼       : ${currentSchedule.receivedAt}`,
        `ì²˜ë¦¬ì¼       : ${r.serviceCompleteDate}`,
        `ì‚¬ìš©ì¼ìˆ˜     : ${usageDays}ì¼`,
        `ìœ ë¬´ìƒ êµ¬ë¶„  : ${warranty}`,
        '',
        `[ì ‘ìˆ˜ë‚´ìš©]`,
        currentSchedule.receiptContent,
        '',
        `[ì²˜ë¦¬ë‚´ìš©]`,
        r.serviceDetail || '-',
    ].join('\n');

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById('copyToast');
            if (toast) { toast.style.display = 'block'; setTimeout(() => { toast.style.display = 'none'; }, 2500); }
        }).catch(() => {
            fallbackCopy(text);
        });
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try {
        document.execCommand('copy');
        const toast = document.getElementById('copyToast');
        if (toast) { toast.style.display = 'block'; setTimeout(() => { toast.style.display = 'none'; }, 2500); }
    } catch(e) {
        alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì„ íƒí•´ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
    }
    document.body.removeChild(ta);
}

function captureWarrantyReport() {
    const reportEl = document.querySelector('#warrantyModal .modal-content');
    if (!reportEl) return;

    // html2canvas ë™ì  ë¡œë“œ
    if (typeof html2canvas === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.onload = () => { doCapture(reportEl); };
        script.onerror = () => { alert('ìº¡ì³ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'); };
        document.head.appendChild(script);
    } else {
        doCapture(reportEl);
    }
}

function doCapture(el) {
    // ë²„íŠ¼ ì˜ì—­ ìˆ¨ê¸°ê³  ìº¡ì³
    const btnGroup = el.querySelector('.button-group');
    const toastCopy = document.getElementById('copyToast');
    const toastCapture = document.getElementById('captureToast');
    if (btnGroup) btnGroup.style.visibility = 'hidden';
    if (toastCopy) toastCopy.style.display = 'none';
    if (toastCapture) toastCapture.style.display = 'none';

    html2canvas(el, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false
    }).then(canvas => {
        if (btnGroup) btnGroup.style.visibility = 'visible';

        // ë‹¤ìš´ë¡œë“œ
        const link = document.createElement('a');
        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(today.getMonth()+1).padStart(2,'0')}${String(today.getDate()).padStart(2,'0')}`;
        const company = (currentSchedule && currentSchedule.company) ? currentSchedule.company.replace(/\s/g,'') : 'report';
        link.download = `ìœ ìƒë¬´ìƒë³´ê³ ì„œ_${company}_${dateStr}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

        const toast = document.getElementById('captureToast');
        if (toast) { toast.style.display = 'block'; setTimeout(() => { toast.style.display = 'none'; }, 2500); }
    }).catch(err => {
        if (btnGroup) btnGroup.style.visibility = 'visible';
        alert('ìº¡ì³ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
    });
}

// ===== SERVICE REPORT SUBMIT =====
function updateFaultMinorOptions() {
    const major = document.getElementById('faultMajor').value;
    const minorSelect = document.getElementById('faultMinor');
    minorSelect.innerHTML = (defectDB[major]||[]).map(m=>`<option value="${m}">${m}</option>`).join('');
    onFaultMinorChange();
}
function updateResultMinorOptions() {
    const major = document.getElementById('resultMajor').value;
    const minorSelect = document.getElementById('resultMinor');
    minorSelect.innerHTML = (serviceResultDB[major]||[]).map(m=>`<option value="${m}">${m}</option>`).join('') || '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
}

function toggleRevisit() {
    isRevisitScheduled = !isRevisitScheduled;
    const dateInput = document.getElementById('serviceCompleteDate');
    if (dateInput) { dateInput.disabled = isRevisitScheduled; dateInput.style.opacity = isRevisitScheduled ? '0.5' : '1'; }
}

function addMaterial() {
    const id = Date.now();
    materials.push({ id, code:'', name:'', qty:1, price:0 });
    renderMaterials();
}
function removeMaterial(id) { materials = materials.filter(m=>m.id!==id); renderMaterials(); }
function updateMaterial(id, field, value) {
    const material = materials.find(m=>m.id===id);
    if (material) material[field] = (field==='qty'||field==='price') ? parseFloat(value)||0 : value;
}
function renderMaterials() {
    const container = document.getElementById('materialsContainer');
    if (!container) return;
    container.innerHTML = materials.map(m => `
        <div class="material-item">
            <div class="material-item-header">
                <span style="font-weight:600;">ìì¬ ${materials.indexOf(m)+1}</span>
                <span class="material-remove" onclick="removeMaterial(${m.id})">Ã—</span>
            </div>
            <div class="form-group">
                <label class="form-label">í’ˆëª©ì½”ë“œ</label>
                <div class="form-input-with-icon">
                    <input type="text" class="form-input" placeholder="í’ˆëª©ì½”ë“œ" value="${m.code}" onchange="updateMaterial(${m.id},'code',this.value)">
                    <span class="form-input-icon" onclick="scanBarcode(${m.id})">ğŸ“·</span>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">í’ˆëª©ëª…</label>
                <input type="text" class="form-input" placeholder="í’ˆëª©ëª…" value="${m.name}" onchange="updateMaterial(${m.id},'name',this.value)">
            </div>
            <div class="form-row-3">
                <div class="form-group"><label class="form-label">ë‹¨ê°€</label><input type="number" class="form-input" value="${m.price}" onchange="updateMaterial(${m.id},'price',this.value);calculateTotal();"></div>
                <div class="form-group"><label class="form-label">ìˆ˜ëŸ‰</label><input type="number" class="form-input" value="${m.qty}" onchange="updateMaterial(${m.id},'qty',this.value);calculateTotal();"></div>
                <div class="form-group"><label class="form-label">ê¸ˆì•¡</label><input type="number" class="form-input" value="${m.price*m.qty}" readonly></div>
            </div>
        </div>`).join('');
}

function scanBarcode(materialId) {
    const material = materials.find(m=>m.id===materialId);
    if (material) { material.code='P-2024-001'; material.name='ì „ì› ì¼€ì´ë¸”'; material.price=15000; renderMaterials(); calculateTotal(); }
}

function calculateTotal() {
    const travelCost = parseFloat(document.getElementById('travelCost').value)||0;
    const materialsCost = materials.reduce((sum,m)=>sum+(m.price*m.qty),0);
    document.getElementById('totalAmount').value = Math.round((travelCost+materialsCost)*1.1);
}

function submitServiceReport() {
    const data = {
        docNo: currentSchedule.docNo,
        serviceDate: document.getElementById('serviceDate').value,
        serviceCompleteDate: document.getElementById('serviceCompleteDate').value,
        serviceWorker: document.getElementById('serviceWorker').value,
        faultMajor: document.getElementById('faultMajor').value,
        faultMinor: document.getElementById('faultMinor').value,
        resultMajor: document.getElementById('resultMajor').value,
        resultMinor: document.getElementById('resultMinor').value,
        serviceDetail: document.getElementById('serviceDetail').value,
        product: document.getElementById('rptProduct').value,
        serial: document.getElementById('rptSerial').value,
        mfgDate: document.getElementById('rptMfgDate').value,
        version: document.getElementById('rptVersion').value,
        materials: materials,
        travelCost: document.getElementById('travelCost').value,
        paymentMethod: document.getElementById('paymentMethod').value,
        totalAmount: document.getElementById('totalAmount').value
    };
    
    console.log('Service Report:', data);
    
    // Save to schedule
    const index = schedules.findIndex(s=>s.docNo===currentSchedule.docNo);
    if (index !== -1) {
        schedules[index].status = 'ì™„ë£Œ';
        schedules[index].savedReport = data;
        sampleSchedules[index].status = 'ì™„ë£Œ';
        sampleSchedules[index].savedReport = data;
        currentSchedule.savedReport = data;
    }
    
    alert('âœ… ì²˜ë¦¬ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n"ìœ ìƒë¬´ìƒ ë³´ê³ ìš©" ë²„íŠ¼ìœ¼ë¡œ ë³´ê³ ì„œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    renderCalendar();
    renderSchedules();
}

// ===== NEW SCHEDULE MODAL =====
function showNewSchedule() {
    const html = `
        <div class="modal-overlay active" id="newScheduleModal" onclick="closeModalOnOverlay(event,'newScheduleModal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-handle"></div>
                    <div class="modal-title-row">
                        <button class="back-button" onclick="closeModal('newScheduleModal')">â€¹</button>
                        <h2 class="modal-title">ì‹ ê·œì ‘ìˆ˜</h2>
                        <button class="close-button" onclick="closeModal('newScheduleModal')">Ã—</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ¢</span> ê³ ê°ì²˜ ì •ë³´</div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label form-label-required">ìƒí˜¸ëª…</label>
                            <input type="text" class="form-input" id="newCompany" placeholder="ìƒí˜¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label form-label-required">ì£¼ì†Œ</label>
                            <input type="text" class="form-input" id="newAddress" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label class="form-label form-label-required">ì „í™”ë²ˆí˜¸</label>
                            <input type="tel" class="form-input" id="newPhone" placeholder="02-1234-5678">
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="section-title-with-camera">
                                <span class="section-icon">âš™ï¸</span> ì¥ë¹„ ì •ë³´
                                <button class="camera-btn-inline" onclick="scanEquipmentBarcode()" title="ë°”ì½”ë“œ ìŠ¤ìº”">ğŸ“·</button>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label form-label-required">ì¥ë¹„ êµ¬ë¶„</label>
                            <div class="device-chip-group" id="newDeviceGroup">
                                <button type="button" class="device-type-chip active" data-dt="ì¸ë°”ë””" onclick="selectDeviceTypeChip(this)">ì¸ë°”ë””</button>
                                <button type="button" class="device-type-chip" data-dt="ì‹ ì¥ê³„" onclick="selectDeviceTypeChip(this)">ì‹ ì¥ê³„</button>
                                <button type="button" class="device-type-chip" data-dt="í˜ˆì••ê³„" onclick="selectDeviceTypeChip(this)">í˜ˆì••ê³„</button>
                                <button type="button" class="device-type-chip" data-dt="ê¸°íƒ€" onclick="selectDeviceTypeChip(this)">ê¸°íƒ€</button>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label form-label-required">ì¥ë¹„ëª…</label>
                            <input type="text" class="form-input" id="newProduct" placeholder="InBody 770">
                        </div>
                        <div class="form-group">
                            <label class="form-label form-label-required">S/N</label>
                            <input type="text" class="form-input" id="newSerial" placeholder="SN-770-2026-001">
                        </div>
                        <div class="form-group">
                            <label class="form-label form-label-required">ë¶ˆëŸ‰ ì¦ìƒ ëŒ€ë¶„ë¥˜</label>
                            <select class="form-select" id="newFaultMajor" onchange="updateNewFaultMinor()">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                ${Object.keys(defectDB).map(major=>`<option value="${major}">${major}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label form-label-required">ë¶ˆëŸ‰ ì¦ìƒ ì†Œë¶„ë¥˜</label>
                            <select class="form-select" id="newFaultMinor"><option value="">ëŒ€ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option></select>
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label class="form-label">ê¸°íƒ€ ë‚´ìš©</label>
                            <textarea class="form-textarea" id="newFaultDetail" placeholder="ì¦ìƒì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ“…</span> ë°©ë¬¸ ì •ë³´</div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label form-label-required">ì ‘ìˆ˜ ìœ í˜•</label>
                            <div class="method-chip-group" id="newMethodGroup">
                                <button type="button" class="method-chip method-chip-active" data-method="ë°©ë¬¸" onclick="selectMethodChip(this)">ë°©ë¬¸</button>
                                <button type="button" class="method-chip" data-method="ì›ê²©" onclick="selectMethodChip(this)">ì›ê²©</button>
                                <button type="button" class="method-chip" data-method="ì…ê³ " onclick="selectMethodChip(this)">ì…ê³ </button>
                                <button type="button" class="method-chip" data-method="íƒë°°" onclick="selectMethodChip(this)">íƒë°°</button>
                                <button type="button" class="method-chip" data-method="ìˆ˜ê±°" onclick="selectMethodChip(this)">ìˆ˜ê±°</button>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label form-label-required">ë°©ë¬¸ì˜ˆì •ì¼</label>
                            <input type="date" class="form-input" id="newVisitDate" value="${formatDate(selectedDate)}">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label class="form-label form-label-required">ë°©ë¬¸ìš”ì²­ì‹œê°„</label>
                            <input type="time" class="form-input" id="newVisitTime" value="09:00">
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="closeModal('newScheduleModal')">ë‹«ê¸°</button>
                        <button class="btn-primary" onclick="submitNewSchedule()">ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>`;
    document.getElementById('modalContainer').innerHTML = html;
}

function selectMethodChip(el) {
    document.querySelectorAll('#newMethodGroup .method-chip').forEach(c => c.classList.remove('method-chip-active'));
    el.classList.add('method-chip-active');
}

function selectDeviceTypeChip(el) {
    document.querySelectorAll('#newDeviceGroup .device-type-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
}

function updateNewFaultMinor() {
    const major = document.getElementById('newFaultMajor').value;
    const minorSelect = document.getElementById('newFaultMinor');
    minorSelect.innerHTML = (defectDB[major]||[]).map(m=>`<option value="${m}">${m}</option>`).join('') || '<option value="">ëŒ€ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
}

function submitNewSchedule() {
    const newSchedule = {
        docNo: `DOC-${formatDate(new Date()).replace(/-/g,'')}-${String(schedules.length+1).padStart(3,'0')}`,
        company: document.getElementById('newCompany').value,
        address: document.getElementById('newAddress').value,
        phone: document.getElementById('newPhone').value,
        receivedAt: formatDate(new Date()),
        visitPlannedAt: document.getElementById('newVisitDate').value,
        visitRequestTime: document.getElementById('newVisitTime').value,
        deviceType: (document.querySelector('#newDeviceGroup .device-type-chip.active') || {}).dataset?.dt || 'ì¸ë°”ë””',
        product: document.getElementById('newProduct').value,
        version: 'v3.0.0',
        mfgDate: '2025-01-01',
        deliveryDate: '2025-02-01',
        serial: document.getElementById('newSerial').value,
        faultMajor: document.getElementById('newFaultMajor').value,
        faultMinor: document.getElementById('newFaultMinor').value,
        receiptContent: document.getElementById('newFaultDetail').value,
        branch: 'ì„œìš¸ì§€ì‚¬',
        visitor: 'ê¹€í”„ë¡œ',
        visitorId: 1,
        prevAction: '',
        method: (document.querySelector('#newMethodGroup .method-chip-active') || {}).dataset?.method || 'ë°©ë¬¸',
        status: 'ëŒ€ê¸°',
        savedReport: null
    };
    if (!newSchedule.company||!newSchedule.address||!newSchedule.phone||!newSchedule.product||!newSchedule.serial||!newSchedule.faultMajor||!newSchedule.faultMinor) {
        alert('âš ï¸ í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    schedules.push(newSchedule);
    sampleSchedules.push(newSchedule);
    alert('âœ… ì‹ ê·œ ì ‘ìˆ˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal('newScheduleModal');
    renderCalendar();
    renderSchedules();
}

// ===== CS INQUIRY MODAL =====
function showCSInquiry() {
    uploadedPhotos = [];
    const currentMonthText = `${currentDate.getFullYear()}ë…„ ${currentDate.getMonth()+1}ì›”`;
    const html = `
        <div class="modal-overlay active" id="csInquiryModal" onclick="closeModalOnOverlay(event,'csInquiryModal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-handle"></div>
                    <div class="modal-title-row">
                        <button class="back-button" onclick="closeModal('csInquiryModal')">â€¹</button>
                        <h2 class="modal-title">CSíŒ€ ë¬¸ì˜</h2>
                        <button class="close-button" onclick="closeModal('csInquiryModal')">Ã—</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ’¬</span> ë¬¸ì˜ ë“±ë¡ Â· ${currentMonthText}</div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label form-label-required">ì œëª©</label>
                            <input type="text" class="form-input" id="inquiryTitle" placeholder="ë¬¸ì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label form-label-required">ìš°ì„ ìˆœìœ„</label>
                            <select class="form-select" id="inquiryPriority">
                                <option value="low">ë‚®ìŒ</option>
                                <option value="medium" selected>ë³´í†µ</option>
                                <option value="high">ë†’ìŒ</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label">ì¥ë¹„ ëª¨ë¸ëª…</label>
                            <input type="text" class="form-input" id="inquiryModel" placeholder="InBody 770">
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label">S/N</label>
                            <input type="text" class="form-input" id="inquirySerial" placeholder="SN-770-2026-001">
                        </div>
                        <div class="form-group" style="margin-bottom:16px;">
                            <label class="form-label form-label-required">ë‚´ìš©</label>
                            <textarea class="form-textarea" id="inquiryContent" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label class="form-label">ì‚¬ì§„ ì²¨ë¶€</label>
                            <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                                <div class="photo-icon">ğŸ“·</div>
                                <div class="photo-text">ì‚¬ì§„ì„ ì´¬ì˜í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”</div>
                            </div>
                            <div class="photo-preview" id="photoPreview"></div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="closeModal('csInquiryModal')">ë‹«ê¸°</button>
                        <button class="btn-primary" onclick="submitCSInquiry()">ì €ì¥</button>
                    </div>
                    <div class="inquiry-list">
                        <div class="inquiry-list-title">ì´ë²ˆ ë‹¬ ë¬¸ì˜ ë‚´ì—­</div>
                        ${csInquiries.map(inq => `
                            <div class="inquiry-card" onclick="showInquiryDetail('${inq.id}')">
                                <div class="inquiry-header">
                                    <div>
                                        <div class="inquiry-title">${inq.title}</div>
                                        <span class="priority-badge priority-${inq.priority}">${inq.priority==='high'?'ë†’ìŒ':inq.priority==='medium'?'ë³´í†µ':'ë‚®ìŒ'}</span>
                                    </div>
                                    <div class="inquiry-date">${inq.date}</div>
                                </div>
                                <div class="inquiry-meta">${inq.model} / ${inq.serial}<br>${inq.content.substring(0,50)}${inq.content.length>50?'...':''}</div>
                            </div>`).join('')}
                    </div>
                </div>
            </div>
        </div>`;
    document.getElementById('modalContainer').innerHTML = html;
}

function handlePhotoUpload(event) {
    const files = event.target.files;
    for (let file of files) {
        const reader = new FileReader();
        reader.onload = (e) => { uploadedPhotos.push(e.target.result); renderPhotoPreview(); };
        reader.readAsDataURL(file);
    }
}

function renderPhotoPreview() {
    const container = document.getElementById('photoPreview');
    if (!container) return;
    container.innerHTML = uploadedPhotos.map((photo,i) => `
        <div class="photo-item">
            <img src="${photo}" alt="Photo ${i+1}">
            <div class="photo-remove" onclick="removePhoto(${i})">Ã—</div>
        </div>`).join('');
}
function removePhoto(index) { uploadedPhotos.splice(index,1); renderPhotoPreview(); }

function submitCSInquiry() {
    const inquiry = {
        id: `INQ-${formatDate(new Date()).replace(/-/g,'')}${String(csInquiries.length+1).padStart(2,'0')}`,
        date: formatDate(new Date()),
        title: document.getElementById('inquiryTitle').value,
        priority: document.getElementById('inquiryPriority').value,
        model: document.getElementById('inquiryModel').value,
        serial: document.getElementById('inquirySerial').value,
        content: document.getElementById('inquiryContent').value,
        photos: uploadedPhotos,
        hqResponse: ''
    };
    if (!inquiry.title||!inquiry.content) { alert('âš ï¸ ì œëª©ê³¼ ë‚´ìš©ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.'); return; }
    csInquiries.push(inquiry);
    alert('âœ… CSíŒ€ ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    showCSInquiry();
}

function showInquiryDetail(inquiryId) {
    const inquiry = csInquiries.find(inq=>inq.id===inquiryId);
    if (!inquiry) return;
    const priorityText = inquiry.priority==='high'?'ë†’ìŒ':inquiry.priority==='medium'?'ë³´í†µ':'ë‚®ìŒ';
    const html = `
        <div class="modal-overlay active" id="inquiryDetailModal" onclick="closeModalOnOverlay(event,'inquiryDetailModal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-handle"></div>
                    <div class="modal-title-row">
                        <button class="back-button" onclick="closeModal('inquiryDetailModal'); showCSInquiry();">â€¹</button>
                        <h2 class="modal-title">ë¬¸ì˜ ìƒì„¸</h2>
                        <button class="close-button" onclick="closeModal('inquiryDetailModal'); showCSInquiry();">Ã—</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="section-icon">ğŸ“‹</span> ë¬¸ì˜ ì •ë³´</div>
                        <div class="detail-row"><span class="detail-label">ë¬¸ì˜ë²ˆí˜¸</span><span class="detail-value">${inquiry.id}</span></div>
                        <div class="detail-row"><span class="detail-label">ë“±ë¡ì¼</span><span class="detail-value">${inquiry.date}</span></div>
                        <div class="detail-row"><span class="detail-label">ì œëª©</span><span class="detail-value">${inquiry.title}</span></div>
                        <div class="detail-row"><span class="detail-label">ìš°ì„ ìˆœìœ„</span><span class="detail-value"><span class="priority-badge priority-${inquiry.priority}">${priorityText}</span></span></div>
                        <div class="detail-row"><span class="detail-label">ì¥ë¹„ ëª¨ë¸ëª…</span><span class="detail-value">${inquiry.model||'-'}</span></div>
                        <div class="detail-row"><span class="detail-label">S/N</span><span class="detail-value">${inquiry.serial||'-'}</span></div>
                        <div class="detail-full"><div class="detail-full-label">ë¬¸ì˜ ë‚´ìš©</div><div class="detail-full-value">${inquiry.content}</div></div>
                    </div>
                    ${inquiry.hqResponse ? `
                        <div class="detail-section">
                            <div class="detail-section-title"><span class="section-icon">ğŸ’¬</span> HQ CS ë‹µë³€</div>
                            <div class="detail-full"><div class="detail-full-value">${inquiry.hqResponse}</div></div>
                        </div>` : `
                        <div class="detail-section">
                            <div class="detail-section-title"><span class="section-icon">â³</span> HQ CS ë‹µë³€ ëŒ€ê¸° ì¤‘</div>
                            <div class="detail-full"><div class="detail-full-value" style="color:var(--text-tertiary);font-style:italic;">ë³¸ì‚¬ CSíŒ€ì—ì„œ ê²€í†  ì¤‘ì…ë‹ˆë‹¤.</div></div>
                        </div>`}
                    <div class="button-group">
                        <button class="btn-primary" onclick="closeModal('inquiryDetailModal'); showCSInquiry();">í™•ì¸</button>
                    </div>
                </div>
            </div>
        </div>`;
    closeModal('csInquiryModal');
    document.getElementById('modalContainer').innerHTML = html;
}

// ===== UTILITIES =====
function closeModal(modalId) {
    // If a specific modal element exists, remove it (supports SMS preview overlay, etc.)
    if(modalId){
        const el = document.getElementById(modalId);
        if(el){
            el.remove();
            return;
        }
    }
    const container = document.getElementById('modalContainer');
    if (container) container.innerHTML = '';
    const smsContainer = document.getElementById('smsModalContainer');
    if (smsContainer) smsContainer.innerHTML = '';
}
function closeModalOnOverlay(event, modalId) {
    if (event.target.id === modalId) closeModal(modalId);
}
function isSameDay(date1, date2) {
    return date1.getFullYear()===date2.getFullYear() && date1.getMonth()===date2.getMonth() && date1.getDate()===date2.getDate();
}
function formatDate(date) {
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

// ===== INITIALIZE =====
init();

</script>
</body>
</html>
